\documentclass[times,modern]{aastex63}

% these lines seem necessary for pdflatex to get the paper size right
\pdfpagewidth 8.5in
\pdfpageheight 11.0in

\usepackage[T1]{fontenc}
\usepackage{epsf,color,amsmath}

\usepackage{cancel}

\newcommand{\sfrac}[2]{\mathchoice%
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
    \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
    \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptscriptfont0 #1}\kern-.2em/
    \kern-.15em\lower.25ex\hbox{\the\scriptscriptfont0 #2}} {#1\!/#2}}


\newcommand{\castro}{{\sf Castro}}
\newcommand{\maestro}{{\sf Maestro}}
\newcommand{\flash}{{\sf Flash}}
\newcommand{\amrex}{{\sf AMReX}}

\newcommand{\isot}[2]{$^{#2}\mathrm{#1}$}
\newcommand{\isotm}[2]{{}^{#2}\mathrm{#1}}

\newcommand{\gcc}{\mathrm{g~cm^{-3} }}
\newcommand{\cms}{\mathrm{cm~s^{-1} }}

\newcommand{\nablab}{{\mathbf{\nabla}}}
\newcommand{\Ub}{\mathbf{U}}
\newcommand{\gb}{\mathbf{g}}
\newcommand{\omegadot}{\dot{\omega}}
\newcommand{\Sdot}{\dot{S}}
\newcommand{\ddx}[1]{{\frac{{\partial#1}}{\partial x}}}
\newcommand{\ddt}[1]{{\frac{{\partial#1}}{\partial t}}}
\newcommand{\odt}[1]{{\frac{{d#1}}{dt}}}
\newcommand{\divg}[1]{{\nablab \cdot \left (#1\right)}}
\newcommand{\dedr}{\left . {\partial{}e}/{\partial\rho}\right |_{T, X_k}}
\newcommand{\dedrd}{\left . \frac{\partial{}e}{\partial\rho}\right |_{T, X_k}}
\newcommand{\dedX}{\left . {\partial{}e}/{\partial{}X_k} \right |_{\rho, T}}
\newcommand{\dedXd}{\left . \frac{\partial{}e}{\partial{}X_k} \right |_{\rho, T, X_{j,j\ne k}}}
\newcommand{\dedT}{\left . {\partial{}e}/{\partial{}T} \right |_{\rho,X_k}}
\newcommand{\dedTd}{\left . \frac{\partial{}e}{\partial{}T} \right |_{\rho,X_k}}

\newcommand{\Ic}{{\boldsymbol{\mathcal{I}}}}
\newcommand{\Ics}{{\mathcal{I}}}
\newcommand{\smax}{{s_\mathrm{max}}}
\newcommand{\kth}{k_\mathrm{th}}
\usepackage{bm}

\newcommand{\Uc}{{\,\bm{\mathcal{U}}}}
\newcommand{\Fb}{\mathbf{F}}
\newcommand{\Sc}{\mathbf{S}}

\newcommand{\xv}{{(x)}}
\newcommand{\yv}{{(y)}}
\newcommand{\zv}{{(z)}}

\newcommand{\ex}{{\bf e}_x}
\newcommand{\ey}{{\bf e}_y}
\newcommand{\ez}{{\bf e}_z}

\newcommand{\Ab}{{\bf A}}
\newcommand{\Sq}{{\bf S}_\qb}
\newcommand{\Sqhydro}{{\Sq^{\mathrm{hydro}}}}
\newcommand{\qb}{{\bf q}}

\newcommand{\Shydro}{{{\bf H}}}
\newcommand{\Hb}{{\bf H}}
\newcommand{\Rb}{{\bf R}}
\newcommand{\Rq}{{\bf R}}
\newcommand{\Adv}[1]{{\left [\boldsymbol{\mathcal{A}} \left(#1\right)\right]}}
\newcommand{\Advt}[1]{{\left [\boldsymbol{\mathcal{\tilde{A}}} \left(#1\right)\right]}}
\newcommand{\Advss}[1]{{\left [{\mathcal{{A}}} \left(#1\right)\right]}}
\newcommand{\Advs}[1]{\boldsymbol{\mathcal{A}} \left(#1\right)}

\newcommand{\avg}[1]{{\left \langle #1 \right \rangle}}

\newcommand{\nse}[1]{{\mathrm{NSE}( #1 )}}

\newcommand{\rhonse}{{\rho_\mathrm{nse}}}
\newcommand{\tnse}{{T_\mathrm{nse}}}
\newcommand{\Anse}{{A_\mathrm{nse}}}
\newcommand{\Bnse}{{B_\mathrm{nse}}}

\newcommand{\out}{{\rm out}}
\newcommand{\inp}{{\rm in}}

\setlength{\marginparwidth}{0.75in}
\newcommand{\MarginPar}[1]{\marginpar{\vskip-\baselineskip\raggedright\tiny\sffamily\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\begin{document}
%======================================================================
% Title
%======================================================================
%\title{A Simplified Spectral Deferred Correction Method for Coupling Hydrodynamics with Reaction Networks and Nuclear Statistical Equilibrium}
\title{An Improved Method for Coupling Hydrodynamics with Reaction Networks and Nuclear Statistical Equilibrium}

%\shorttitle{A Simplified SDC Method}
\shorttitle{Hydro/Reaction Coupling with NSE}


\shortauthors{}

%% \author[0000-0001-8401-030X]{M.~Zingale}
%% \affiliation{Dept.\ of Physics and Astronomy, Stony Brook University,
%%        Stony Brook, NY 11794-3800}

%% \author[0000-0003-0439-4556]{M.~P.~Katz}
%% \affiliation{Nvidia Corp}

%% \author[0000-0002-5749-334X]{J.~B.~Bell}
%% \affiliation{Center for Computational Sciences and Engineering, Lawrence Berkeley National Laboratory, Berkeley, CA  94720}

%% \author[0000-0003-1791-0265]{A.~J.~Nonaka}
%% \affiliation{Center for Computational Sciences and Engineering, Lawrence Berkeley National Laboratory, Berkeley, CA  94720}

%% \author[0000-0001-8092-1974]{W.~Zhang}
%% \affiliation{Center for Computational Sciences and Engineering, Lawrence Berkeley National Laboratory, Berkeley, CA  94720}

%% \correspondingauthor{Michael Zingale}
%% \email{michael.zingale@stonybrook.edu}


%======================================================================
% Abstract and Keywords
%======================================================================
\begin{abstract}
Reacting astrophysical flows can be challenging to model because of
the difficulty in accurately coupling hydrodynamics and reactions.
This can be particularly acute at high temperatures where nuclear
statistical equilibrium is established.  We develop a simplified
approach based on spectral deferred corrections (SDC) coupling of explicit
hydrodynamics and stiff reaction sources as an alternative to operator
splitting or the more comprehensive SDC approach we demonstrated
previously.  We apply the new method to some example problems and show
how to modify it to work with a hybrid network consisting of a
reaction ODE system and a table for nuclear statistical equilibrium.
This is all done in the framework of the \castro\ hydrodynamics code,
and all algorithm implementations are freely available.
\end{abstract}

\keywords{hydrodynamics---methods: numerical}

%======================================================================
% Introduction
%======================================================================
\section{Introduction}\label{Sec:Introduction}

Reactive flow can be challenging to model when changes in the
nuclear abundances due to reactions are integrated over hydrodynamic
time scales.  Traditional methods of coupling
hydrodynamics and reactions used in astrophysics use operator
splitting---each physical process acts on the output of the previous
process in alternating fashion.  This makes it easy to add physics in a modular way to a
simulation code, but competition between physical processes can cause
the coupling to breakdown.  These splitting errors can lead to loss of
accuracy and further time step limitations.

A particularly difficult phase of evolution to model is the nuclear
statistical equilibrium that sets in for
temperatures in excess of $\mbox{few} \times 10^9~\mathrm{K}$.  Physically, the
forward and reverse rates of reaction should balance leading to an equilibrium.
With operator splitting, an NSE region will have a large positive flow
through the network in a zone in one step followed by a large negative
flow over the next timestep, as the code struggles to produce an
equilibrium.  These large changes in abundances (and large alternately
positive and negative energy generation rates) can be a challenge for
a code.  The easiest way to improve the coupling is to cut the
timestep, but this makes simulations prohibitively expensive.
Sometimes the burning is simply halted on a zone-by-zone basis when
NSE conditions are reached (e.g., as in \citealt{hedet}).
Alternately, at high temperatures, a reaction network can be replaced
with a table of NSE abundances and the zone's composition set through
table look-ups (e.g.\ \citealt{ma:2013}) \MarginPar{need more here}

In \cite{castro_sdc}, we developed second- and fourth-order accurate
methods in space and time for coupling hydrodynamics and nuclear
reaction networks based on spectral deferred corrections (SDC)
methods, and demonstrated the method in a variety of test problems.
The approach presented here is considerably simpler from a temporal
integration standpoint, but allows is to incorporate modifications
for regions in nuclear statistical equilibirum.
Furthermore, we reuse the main
CTU hydrodynamics construction and a largely similar ODE integration
scheme, making this method easier to add to existing simulation codes.
It also extends to adaptive mesh refinement with subcycling in a
straightforward manner, avoiding the complications described in
\citep{mccorquodalecolella} needed to fill ghost cells when using
method-of-lines integration.  However, it is restricted to
second-order accuracy overall.  We term this algorithm the
``simplified SDC method''.  We use the \castro\ hydrodynamics code
\citep{castro} for all of our numerical experiments, and all of the
code to reproduce the results in this paper are in the \castro\ github
repository\footnote{\url{https://github.com/amrex-astro/Castro/}}.

\section{Numerical Methodology}


We solve the Euler equations for compressible, reacting flow.  For ease
of exposition we describe the one-dimensional case;
multidimensional extensions are a straightforward modification to
include the CTU hydrodynamics scheme.
The system appears as:
\begin{equation}
\frac{\partial \Uc_t}{\partial t}  + \frac{\partial \Fb^\xv (\Uc)}{\partial x} = \Sc(\Uc)
\end{equation}
where
\begin{equation}
\Uc = \left ( \begin{array}{c}
           \rho \\
           \rho X_k \\
           \rho \alpha_l \\
           \rho u \\
           \rho E \end{array}\right )
\end{equation}
are the conserved fluid quantities: mass density, $\rho$, velocity,
$u$, specific total energy, $E$, and nuclear species mass fractions,
$X_k$, and auxiliary composition variables, $\alpha_l$.  The mass fractions
are constrained to sum to 1, $\sum_k X_k = 1$, but no such constraint
exists on the auxiliary variables.  The specific total energy relates
to the specific internal energy as $E = e + u^2/2$.  The corresponding
fluxes are
\begin{equation}
\Fb^\xv (\Uc) = \left ( \begin{array}{c}
   \rho u \\
   \rho X_k u \\
   \rho \alpha_l u \\
   \rho u u + p \\
   \rho u E + u p
   \end{array} \right )
\end{equation}
Here the pressure, $p$, enters, and is found via the equation of state.  For a system
where the composition is completely specified by the mass fractions, $X_k$, the equation
of state would take the form:
\begin{equation}
p = p(\rho, X_k, e)
\end{equation}
However, as we'll see shortly, when we use the NSE table, we are using
the results of a much larger network then can be represented by the
mass fractions, and in this case, we rely on the auxiliary composition
variables, $\alpha_l$, to describe the state of the composition, and
our EOS has the form:
\begin{equation}
p = p(\rho, \alpha_l, e)
\end{equation}

We decompose the source terms, $\Sc(\Uc)$, into
hydrodynamical sources, $\Hb$ (like gravity), and reactive sources,
$\Rb$,
\begin{equation}
  \Sc(\Uc) = \Hb(\Uc) + \Rb(\Uc).
\end{equation}
\MarginPar{Detail out what is $\Hb(\Uc)$?}
 The reactive sources take the form:
\begin{equation}
  \Rb(\Uc) = \left ( \begin{array}{c}
     0 \\
     \rho \omegadot(X_k) \\
     \rho \omegadot(\alpha_l) \\
     0 \\
     \rho \dot{S}
  \end{array} \right )
\end{equation}
where $\omegadot(X_k)$ is the creation rate for species $k$, $\omegadot(\alpha_l)$ is the creation rate for
auxiliary composition variable $l$, and $\dot{S}$
is the energy generation rate per unit mass.

Sometimes it is preferable to work with the primitive variables,
\begin{equation}
\qb = \left ( \begin{array}{c}
  \rho \\
  X_k \\
  \alpha_l \\
  u \\
  p \\
  (\rho e) \\
\end{array} \right )
\end{equation}
Here, the system appears
as:
\begin{equation}
\qb_t + \Ab^\xv(\qb) \qb_x  = \Sq
\end{equation}
with the matrix $\Ab^\xv$ giving the coefficients of the spatial derivatives
of the primitive variables:
\begin{equation}
\Ab^\xv(\qb) = \left ( \begin{array}{cccccc}
    u & 0 & 0 & \rho & 0 & 0 \\
    0 & u & 0 & 0    & 0 & 0 \\
    0 & 0 & u & 0    & 0 & 0 \\
    0 & 0 & 0 & u    & 1/\rho & 0 \\
    0 & 0 & 0 & \Gamma_1 p & u & 0 \\
    0 & 0 & 0 & \rho h & 0 & u
  \end{array} \right )
\end{equation}
where $\Gamma_1$ is an adiabatic index,
$\Gamma_1 = d\log p/d\log\rho|_s$ at constant entropy.
Note, the primitive state has two thermodynamic quantities, $p$
and $(\rho e)$, to more efficiently handle the general equation of
state in the Riemann solver, as described in \citet{castro}, but
alternate formulations are possible \citep{colellaglaz:1985}.
The source term vector, $\Sq$, can again be decomposed into hydrodynamic
sources (now in terms of the primitive variables) and reaction terms,
\MarginPar{Can we use $\Sc(\qb)$ instead of $\Sq$ and $\Hb(\qb)$ instead of $\Sqhydro$ to keep notation consistent with the conserved variables, since you are already doing that with $\Rb(\qb)$?}
\begin{equation}
  \Sq = \Sqhydro + \Rb(\qb)
\end{equation}
with
\begin{equation}
\label{eq:prim_sources}
\Rb(q) = \left ( \begin{array}{c}
     0 \\
     \omegadot(X_k) \\
     \omegadot(\alpha_l) \\
     0 \\
     \Gamma_1 p \sigma \Sdot \\
     \rho \Sdot
   \end{array} \right )
\end{equation}
where
\begin{equation}
\sigma \equiv \frac{\partial p/\partial T |_\rho}{\rho c_p \partial p/\partial \rho |_T}
\end{equation}
and $c_p$ is the specific heat at constant pressure, $c_p = \partial
h/\partial T |_p$.  A derivation of this source for the pressure
equation can be found in \cite{ABNZ:III}.  We note that this source is
algebraically identical to that shown in Eq.~25 of \cite{castro}.



We use the \castro\ hydrodynamics code~\cite{castro}, together with
corner transport upwind piecewise parabolic method
hydrodynamics~\citep{millercolella:2002}.  This is a finite-volume
method that uses characteristic tracing to predict a time-centered
flux through the interfaces of the grid zones.  For pure
hydrodynamics, these time-centered fluxes result in second-order
accurate time integration.  With reactions, we want to couple
hydrodynamics and the reaction sources to second order.  Nuclear
reaction sources are stiff, and need to be integrated using implicit
methods for stabilty.  Operator splitting (e.g., Strang) is traditionally employed
here, and is used as a benchmark for comparison in this paper.



\subsection{Strang Splitting}

In Strang splitting, we first integrate the system with reactions terms only (no advection)
over $\Delta t/2$, then integrate the advection terms only (no reactions) over $\Delta t$,
and finally integrate the reaction terms only over $\Delta t/2$.

In the absence of advective terms, our reaction system appears as just
$d\Uc/dt = \Rb(\Uc)$, or:
\begin{align}
\odt{\rho} & = 0 \\
\odt{(\rho X_k)} &= \rho \omegadot(X_k) \\
\odt{(\rho \alpha_l)} &= \rho \omegadot(\alpha_l) \\
\odt{(\rho u)} &= 0 \\
\odt{(\rho E)} &= \rho \Sdot
\end{align}
We can write the energy equation as:
\begin{equation}
\odt{(\rho E)} = \odt{(\rho e)} + \odt{K} = \rho \Sdot
\end{equation}
where $K$ is the kinetic energy, $K = |u|^2/2$.  Since the density and velocity
are unchanged by reactions, we consider the following:
\begin{equation}
\odt{(\rho e)} = \rho \odt{e} = \rho \Sdot
\end{equation}
The reaction rates are typically expressed as $\omegadot_k(\rho, T, X_k)$
when we evolve this system.  This requires an EOS inversion to get $T$ from $e$ each
time we need to evaluate the reactive terms.
We choose to instead integrate the temperature.
We can write the energy equation as:
\begin{equation}
\rho \odt{e} = \rho \left [ \underbrace{\left . \frac{\partial e}{\partial T} \right |_\rho}_{c_v}
                            \odt{T} +
                            \left . \frac{\partial e}{\partial \rho} \right |_T
                            \cancelto{0}{\odt{\rho}} \;\; \right ] = \rho \Sdot
\end{equation}
reducing to
\begin{equation}
\label{eq:strang:T}
\odt{T} = \frac{1}{c_v} \Sdot
\end{equation}
We can alternately derive this from an enthalpy equation, which is the
correct formulation when we are at constant pressure, and we get the
same temperature equation but with $c_v$ replaced by $c_p$.
Technically this requires an EOS call to get $c_x$, but if the
specific heat varies slowly, we can freeze it during the reaction
solve or use a Taylor expansion in $T$ to capture slow evolution.

We also typically integrate mass fraction itself, instead of partial
densities:
\begin{equation}
\label{eq:strang:X}
\odt{X_k} = \omegadot_k
\end{equation}
We integrate Equations (\ref{eq:strang:T}) and (\ref{eq:strang:X}) using
an implicit ODE solver designed for stiff systems of
equations, VODE~\citep{vode}.

With Strang splitting, the state can drift significantly off of the
smooth solution to the coupled reactive hydrodynamics equations, as
shown graphically in \cite{astronum:2018} using an earlier version of
the present algorithm.

A variation on Strang splitting called (re-)balanced splitting was
developed in \citet{speth:2013}.


\subsection{Timestep Limiters and Retry Mechanism}

Since this method is based off of the CTU hydrodynamics scheme, it
benefits from the larger timestep that method can take (when done with
full corner coupling, the advective CFL condition is unity)
as compared to a method-of-lines approach (see
\citealt{ppmunsplit}).  In addition to the standard CFL timestep
limiter for explicit hydrodynamics, \castro\ can also enforce
timestep limiters based on the energy generation or abundance changes
over a timestep: \MarginPar{do we enforce this in the NSE region?}
\begin{align}
\label{eq:dt:nuce}
\Delta t &\le f_e\, \min_{i} \left\{\frac{e_{i}}{\dot{S}_{i}}\right\} \\
%
\label{eq:dt:nucX}
\Delta t &\le f_X\, \min_{i} \left\{\min_{k,X_k > \epsilon_X}\frac{{X_k}_{i}}{{\omegadot(X_k)_i}}\right\}
\end{align}
where $i$ is the zone index and $f_e$ and $f_X$ are runtime parameters
used to control the allowed change, and only species for which $X_k > \epsilon_X$ are considered.

\castro\ has the ability to reject a timestep if it detects a failure
and retry with smaller timesteps (subcycling to make up the original
required timestep).  Among the conditions that can trigger this are
density falling below zero during advection, the ODE integration
failing to converge in the implicit solve, or violation of one of the
timestep limiters during the step.  This means that equations
(\ref{eq:dt:nuce}) and (\ref{eq:dt:nucX}) are not reactive, but instead
guaranteed to be met throughout the simulation, because the step is
rejected if they are violated.  This contrasts to similar approaches
used in other codes where conditions \ref{eq:dt:nuce} and
\ref{eq:dt:nucX} are used to restrict the next timestep size, but the
update over the current step is kept, which already violated the
constraints. \MarginPar{would be nice to have a reference here} The retry mechanism in \castro\ works with both the
Strang and simplified-SDC integration scheme.


\subsection{Spectral Deferred Corrections}

The basic idea of spectral deferred corrections is to express the
update as an integral and divide the time-update into a number of
discrete time nodes.  The integral is then approximated using a
quadrature rule over these time nodes and low order approximations are
used to update the state from one time node to the next.  The method
uses iteration to successively improve the solution and the ultimate
accuracy is determined by the quadrature method used to evaluate the
integral, which is done using an iteratively-lagged solution.

We start by writing our update as:
\begin{equation}
\Uc^{n+1} = \Uc^n + \int_t^{t+\Delta t} \left [ \Advs{\Uc} + \Rb(\Uc) \right ] dt,
\end{equation}
where $\Advs{\Uc} =  -{\partial \Fb^\xv (\Uc)}/{\partial x} + \Hb(\Uc)$.
For the simplified SDC method we explore here, we will make the
advective term piecewise constant in time, using the value at the
midpoint in time, to achieve second-order accuracy, giving us:
\begin{equation}
\label{eq:integral:simplesdc}
\Uc^{n+1} = \Uc^n + \int_t^{t+\Delta t} \left \{ \Adv{\Uc}^{n+1/2} + \Rb(\Uc) \right \} dt
\end{equation}
This is the approach first shown in \citep{SDC-old}.  A
version of this was also implemented in the \maestro\ low-Mach number
hydrodynamics code some time ago.  The compressible version for use in
\castro\ is slightly different due to the need to do some operations
on the conserved variable state and some on the primitive variable
state.  We describe the application of this to the equations of
compressible hydrodynamics below.

\begin{itemize}

\item {\em Initialization}

\label{sec:initialization}

  \begin{itemize}
  \item We need an approximation of how much the reactions alone
    changed the primitive variable state over the timestep, which we
    will denote $\Ic_q$.  Since we do not have any information about
    the current timestep in the first iteration,
    we use the value from the last iteration of the previous timestep:
    \begin{equation}
      \Ic^{n+1/2,(0)}_{\qb} = \Ic^{n-1/2,(\smax)}_{\qb}
    \end{equation}
    \MarginPar{changed to 1-based $k$ iteration for aesthetics?  I can switch it back if you prefer ``-1'' to be the starting point instead of ``0''.}
  %% \item Solve the Poisson problem for the initial gravitational potential:
  %%   \begin{equation}
  %%     \nabla^2 \Phi^n = 4\pi G \rho^n
  %%   \end{equation}

  %% \item Set the first guess at the new time potential as
  %%   $\Phi^{n+1,(0)} = \Phi^n$.

  \end{itemize}

\item {\em Iterate}

  Iterate from $k = 1, \ldots, \smax$.  For second-order accuracy,
  $\smax = 2$ is sufficient.  In addition to denoting the time-level
  with a superscript (like $n$ or $n+1$), we'll use a second subscript
  in parentheses to keep track of the iteration.  A single iteration
  starts with $\Uc^n$ and results in the new time-level state for that
  iteration, $\Uc^{n+1,(k)}$.

  \begin{itemize}
  \item {\em Create the advective update term, $\Adv{\Uc}^{n+1/2,(k)}$}

    \begin{itemize}
    \item convert $\Uc \rightarrow \qb$.  This is an algebraic transformation,
      but will require the EOS.

    \item predict $\qb$ to the interfaces at $t^{n+1/2}$ using the CTU PPM
      method.  The source terms, $\Sq$, used in the prediction are:
      \begin{equation}
        \Sq = \Sqhydro^{n+1/2} + \Ic_\qb^{n+1/2,(k-1)}
      \end{equation}
      Here we use the iteratively lagged integrals of the primitive variable
      terms accounting only for reactions, $\Ic_\qb^{n+1/2,(k-1)}$, as the
      reactive source.  This is in contrast to Strang-splitting, where no
      explicit reactive source terms are seen by the hydrodynamics update.
      Any hydrodynamic source terms are time-centered
      using the previous iteration:
\MarginPar{Formally both $t^n$ or $t^{n+1/2}$ sources give you 2nd-order since they are CTU predictor source terms.  I've never found this type of iteration for this term to amount to any benefit}
      \begin{equation}
        \Sqhydro^{n+1/2} = \frac{1}{2} \left ( \Sqhydro^n + \Sqhydro^{n+1,(k-1)} \right )
      \end{equation}

    \item solve the Riemann problem at each interface to get a unique
      conserved state on each interface, $\Uc^{n+1/2,(k)}_{i+1/2}$

    \item construct the advective update terms, $\Advt{\Uc}^{n+1/2,(k)}_{i}$,
      by first ignoring the hydrodynamics sources,
      \begin{align}
        \Advt{\Uc}^{n+1/2,(k)}_{i} =
          &- \frac{\Fb^\xv(\Uc^{n+1/2,(k)}_{i+1/2}) - \Fb^\xv(\Uc^{n+1/2,(k)}_{i-1/2})}{\Delta x}
      \end{align}
    Now the conservative hydrodynamics source terms are computed by first updating to the
    new state with advection and the old-time source term applied for the full $\Delta t$ as:
\MarginPar{I'm confused what happens with the $\Uc^{\star\star}$ state; I don't see it below.  Is The $\Shydro^{n+1/2}$ used below suppose to be from the $\Uc^{\star\star}$ state?}
    \begin{equation}
      \Uc^{\star\star} = \Uc^n + \Delta t \Advt{\Uc}^{n+1/2,(k)} + \Delta t \Hb(\Uc^n)
    \end{equation}
    %% first updating the density to the new state with advection only as:
    %% \begin{equation}
    %%   \rho^{\star\star} = \rho^n + \Delta t \Advt{\rho}^{n+1/2,(k)}
    %% \end{equation}
    %% then constructing the momentum source term:
    %% \begin{equation}
    %%   {\bf S}_{\rho\Ub}^{n+1/2} = \frac{1}{2} (\rho^n \gb^n + \rho^{\star\star} \gb^{n+1,(k-1)})
    %% \end{equation}
    %% Then updating the momentum with only advection as:
    %% \begin{equation}
    %%   (\rho \Ub)^{\star\star} = (\rho \Ub)^n + \Delta t \Advt{\rho\Ub}^{n+1/2,(k)} + \Delta t {\bf S}_{\rho\Ub}^{n+1/2}
    %% \end{equation}
    %% and finally constructing the energy source:
    %% \begin{equation}
    %%   S_{\rho E}^{n+1/2} = \frac{1}{2} \left [ (\rho\Ub)^n \cdot \gb^n + (\rho\Ub)^{\star\star} \cdot \gb^{n+1,(k-1)}
    %%     \right ]
    %% \end{equation}
    We then evaluate the source terms with $\Uc^{\star\star}$ and
    correct the advective term so that we have a time-centered
    source: \MarginPar{are we actually doing this correctly for SDC?}
    The final advective update term is then\footnote{For a source like gravity, this update can be done first for $\rho$ and then define the new momentum source using $\rho^{\star\star}$ and likewise for energy}:
    \begin{equation}
      \Adv{\Uc}^{n+1/2,(k)}_{i} = \Advt{\Uc}^{n+1/2,(k)}_{i} +
      \frac{\Delta t}{2} \left (\Shydro(\Uc^n) + \Shydro(\Uc^{\star\star}) \right )
    \end{equation}

    %% with
    %% \begin{equation}
    %%   \Shydro^{n+1/2} = \left ( \begin{array}{c}
    %%                  0 \\ 0 \\ 0 \\
    %%                 {\bf S}_{\rho\Ub}^{n+1/2} \cdot \ex \\
    %%                 S_{\rho E}^{n+1/2} \end{array} \right )
    %% \end{equation}

    \MarginPar{if $\Shydro$ depended on the outcome of the burn, we might need to do things differently here}

    \end{itemize}

  \item {\em Update the System Using a Method of Lines Integration}

    We update the state by doing the integral in equation
    (\ref{eq:integral:simplesdc}).  Since we are approximating the
    advective term as piecewise constant in time, we can simply use an
    ODE integrator to integrate this, just as we do with the reaction
    system in Strang splitting.  The difference here being that we are
    integrating the conserved variables and the state sees the effect
    of advection as we integrate the reactions.  So rather than use
    $d\Uc/dt = \Rb(\Uc)$, the ODE form we use is
    \begin{equation}
      \odt{\Uc} = \Adv{\Uc}^{n+1/2,(k)} + \Rb(\Uc)
    \end{equation}
    This integration begins with $\Uc^n$ and results in $\Uc^{n+1,(k)}$.

    As we are integrating this system we need to get the
    temperature, $T$, for the rate evaluations.  We construct this
    by subtracting the kinetic energy from the total energy to get
    the specific internal energy, $e$, and then calling the equation
    of state.

    Our integrator also needs the Jacobian of the system, in terms of
    the conserved variables.  This is different than the form of the
    Jacobian usually used in reaction networks.  We describe the form
    of the Jacobian in appendix \ref{sec:app:jacobian}.

    Note that our advection terms are piecewise
    constant \MarginPar{need to think about this more} approximations,
    so when we integrate our system, their contributions will be
    linear in time.  Since $(\rho X_k)$ sees a linear advective term,
    $\rho$ does as well.  $(\rho u)$ will also have linear
    contributions in time from advection.  Since the reactions don't
    affect $\rho$ and $(\rho u)$, we can algebraically update these
    using this piecewise linear behavior:
    \begin{align}
      \rho(t) &= \rho^n + \Advss{\rho}^{n+1/2,(k)} \, t \\
      (\rho u)(t) &= (\rho u)^n + \Advss{\rho u}^{n+1/2,(k)} \, t
    \end{align}

  \item {\em Compute the Reactive Source Terms.}

    We now seek the $\Ic$'s that capture the effect of just the
    reaction sources on the state variables for the next iteration.
    For the conserved quantities, these would simply be:
    \begin{equation}
      \Ic^{(k)}_{\Uc} = \frac{\Uc^{n+1,(k)} - \Uc^n}{\Delta t} - \Adv{\Uc}^{n+1/2,(k)}
    \end{equation}
    However, for our primitive variables, which are used in the
    prediction, we need to construct the required source terms more
    carefully.  We want:
    \begin{equation}
      \label{eq:Iq}
      \Ic^{(k)}_{\qb} = \frac{\qb^{n+1,(k)} - \qb^n}{\Delta t} - \Adv{\qb}^{n+1/2,(k)}
    \end{equation}
    but we need the advective update for $\qb$, which we have not
    constructed.  We note that $\Ic^{(k)}_\qb$ is an approximation to the integral of 
    Eq.~\ref{eq:prim_sources} over the timestep.  Additionally, we cannot simply use the equation of
    state on $\Ic^{(k)}_{\Uc}$ since this is a time-derivative and
    does not represent a well-defined state in itself.  Instead, we
    derive $\Ic^{(k)}_{\qb}$ via a multi-step process.  We first find
    the conservative state as if it were updated only with advection:
    \begin{equation}
      \Uc^\star = \Uc^n + \Delta t \Adv{\Uc}^{n+1/2,(k)}
    \end{equation}
    and then construct the corresponding primitive variable state via an algebraic transform,
    $\Uc^\star \rightarrow \qb^\star$.
    This allows us to define the advective update for $\qb$ as:
    \begin{equation}
      \Adv{\qb}^{n+1/2,(k)} = \frac{\qb^\star - \qb^n}{\Delta t}
    \end{equation}
    Defining the primitive state corresponding to the fully-updated
    conserved state via an algebraic transform, $\Uc^{n+1,(k)}
    \rightarrow \qb^{n+1,(k)}$, we can construct $\Ic^{(k)}_{\qb}$ as given
    in Equation (\ref{eq:Iq}).
    Putting all of this together, we see:
    \begin{equation}
      \Ic^{(k)}_{\qb} = \frac{\qb^{n+1,(k)} - \qb^\star}{\Delta t}
    \end{equation}



  %% \item {\em Solve for the New Gravitational Potential.}

  %%   We solve
  %%   \begin{equation}
  %%     \nabla^2 \Phi^{n+1,(k)} = 4\pi G \rho^{n+1,(k)}
  %%   \end{equation}

  \end{itemize}

\end{itemize}



\section{Reaction Networks and Nuclear Statistical Equilibrium}

For this study we will use the 19 nuclei network containing
\isot{H}{1}, \isot{He}{3}, \isot{He}{4}, \isot{C}{12}, \isot{N}{14},
\isot{O}{16}, \isot{Ne}{20}, \isot{Mg}{24}, \isot{Si}{28},
\isot{S}{32}, \isot{Ar}{36}, \isot{Ca}{40}, \isot{Ti}{44},
\isot{Cr}{48}, \isot{Fe}{52}, \isot{Fe}{54}, \isot{Ni}{56}, protons
(from photodisintegration), and neutrons.  This is based on the
``aprox19'' network from \cite{aprox19} and originally described in
\cite{Kepler}.  We use a modified version of the VODE~\citep{vode} integrator---ported to C++ with checks added to the timestep rejection logic that ensure that the species mass fractions stay between 0 and 1\footnote{This modified version of VODE is available in our Microphysics repo: \url{https://github.com/starkiller-astro/Microphysics}.}.\MarginPar{discuss tolerances}  We combine this with a table that gives the nuclear
statistical equilibrium (NSE) abundances in regions where the system
is in NSE.  The NSE table was generated using a 127 nuclei reaction
network and is the same as described in \cite{ma:2013}.  In our
simulations, we carry all 19 isotopes in the main network in each zone
and advect them in the hydrodynamics portion of the algorithm.  The
composition of the larger 127 nuclei network is mapped into the 19
isotopes we carry according to Table \ref{table:nuclei}.

The NSE table requires: \MarginPar{need a statement about how the table was constructed and what NSE means}
\begin{equation}
  \label{eq:aux:ye}
  Y_e = \sum_k \frac{Z_k X_k}{A_k}
\end{equation}
(where $A_k$ and $Z_k$ are the atomic weight and atomic number of nucleus $k$) and provides
\begin{align}
\label{eq:aux:abar}
\bar{A} &= \left [ \sum_k \frac{X_k}{A_k} \right ]^{-1} \\
\label{eq:aux:bea}
\left (\frac{B}{A} \right ) &= \sum_k \frac{B_k X_k}{A_k}
\end{align}
where $B_k$ is the binding energy of nucleus $k$.  In our simulations,
we store these 3 quantities as auxiliary data that is carried along
with the rest of the fluid state in each zone.  The table also returns
values of the mass fractions mapped onto the 19-isotopes we carry, $X_k$, and the time-derivative of $Y_e$, $dY_e/dt$.
We use the notation:
\begin{equation}
\nse{\rho,T,Y_e} \rightarrow \bar{A}, X_k, (B/A), dY_e/dt
\end{equation}
to represent the NSE table call and its inputs and outputs.

We can derive evolution equations for each of these composition quantities as:
\begin{align}
\frac{DY_e}{Dt} &= \sum_k \frac{Z_k}{A_k} \frac{DX_k}{Dt} = \sum_k \frac{Z_k}{A_k} \omegadot_k \\
\frac{D\bar{A}}{Dt} &= -\bar{A}^2 \sum_k \frac{1}{A_k} \frac{DX_k}{Dt} = -\bar{A}^2 \sum_k \frac{1}{A_k} \omegadot_k \\
\frac{D}{Dt} \left (\frac{B}{A} \right ) &= \sum_k \frac{B_k}{A_k} \frac{DX_k}{Dt} = \sum_k \frac{B_k}{A_k} \omegadot_k
\end{align}
For Strang split coupling of hydro and reactions, $DX_k/Dt = 0$,
therefore each of these auxillary equations obeys an advection
equation in the hydro part of the advancement.  In the SDC algorithm,
there will be a reactive source (an $\Ic_q$) for each of these that is
computed in the same manner as above.  We note that our NSE table
provides the evolution of $Y_e$ due to reactions ($DY_e/Dt$) directly.

The compositional quantities
it carries, $\bar{A}$ and $Y_e$ are not representable from the 19
isotopes we carry in the main network. For this reason, when we are
using the NSE network, we always provide these two composition quantities as
inputs to the EOS rather than using the $X_k$ directly.
the EOS directly from the auxiliary state in each zone instead of
using the $X_k$ directly.
Our equation of state needs the mean charge per nucleus, $\bar{Z}$, in addition
to the auxiliary quantities, which is computed as
\begin{equation}
\bar{Z} = \bar{A} \sum_k \frac{Z_k X_k}{A_k} = \bar{A} Y_e
\end{equation}
(see, e.g., \citealt{flash}).

\subsection{Initialization}

We initialize the mass fractions, $X_k$, and then compute the
electron fraction, $Y_e$, using (\ref{eq:aux:ye}).
For the two other composition
quantities we carry, $\bar{A}$, and $(B/A)$, we need values that are
consistent with the value of $Y_e$ and the nuclei stored in the NSE
table.  Therefore, if the thermodynamic conditions put us in NSE
(using the conditions defined below), then we obtain $\bar{A}$ and
$(B/A)$ from the NSE table.  Otherwise, we compute these directly from
$X_k$ using (\ref{eq:aux:abar}) and (\ref{eq:aux:bea}).

\subsection{NSE condition}

We treat a zone as being in NSE if the density and temperature exceed
some threshold and the composition is mainly $\alpha$ and Fe-group
nuclei, where the Fe-group nuclei are \isot{Cr}{48}, \isot{Fe}{52},
\isot{Fe}{54}, and \isot{Ni}{56}.  The full condition is:
\begin{align}
\rho &> \rhonse \\
T &> \tnse \\
X(\isotm{C}{12}) &< \Anse \\
X(\isotm{He}{4}) + \sum_{k \in \mathrm{Fe-group}} X_k &> \Bnse
\end{align}
Typical values are $\rhonse = 3\times 10^8~\gcc$, $T_\mathrm{nse} =
3\times 10^9~\mathrm{K}$, and $\Anse = 0.12$ and $\Bnse=
0.88$---these are the values used in \citet{ma:2013}.

\subsection{Strang-split algorithm for NSE}

For Strang splitting, we alternate the reaction and hydrodynamics,
with each operation working on the output of the previous operation.
If we define an advection operator over a timestep $\Delta t$ acting on $\Uc$ as
$\mathbb{A}_{\Delta t}(\Uc)$ and a reaction operator over a timestep of
$\Delta t/2$ acting on $\Uc$ as $\mathbb{R}_{\Delta t/2}(\Uc)$, then the advance appears
as:
\begin{align}
  \Uc^\star &= \mathbb{R}_{\Delta t/2}(\Uc^n) \\
  \Uc^{n+1,\star} &= \mathbb{A}_{\Delta t}(\Uc^\star) \\
  \Uc^{n+1} &= \mathbb{R}_{\Delta t/2}(\Uc^{n+1,\star})
\end{align}
Tthe hydrodynamic and reactive substeps over
the overall time-advancemenet scheme using the aprox19 + NSE network
are as follows:
\begin{itemize}

\item {\em Hydrodynamics update}
  
  At the beginning of each hydrodynamic update we have an input state,
  $\Uc_{\rm in}$ that we wish to integrate over $\Delta t$ to obtain $\Uc_{\rm out}$
  The hydrodynamics update proceeds as normal, but with an advection
  equation for each of the auxiliary composition variables:
  \begin{align}
    \ddt{(\rho Y_e)} + \ddx{(\rho Y_e u)} &= 0 \\
    \ddt{(\rho \bar{A})} + \ddx{(\rho \bar{A} u)} &= 0 \\
    \ddt{[\rho (B/A)]} + \ddx{[\rho (B/A) u]} &= 0 
  \end{align}


\item {\em Reactive update}

  At the beginning of each reactive update we have an input state,
  $\Uc_{\rm in}$ that we wish to integrate over $\Delta t/2$ to obtain $\Uc_{\rm out}$.
  
  \begin{itemize}

    \item For a zone that is in NSE:

      The goal is to update the composition and thermodynamics due to the 
      change in the nuclei abundances over the (half-)timestep.  \citet{ma:2013}
      uses a first-order in time difference to get the new composition state
      and evaluates the energy release from the change in binding energy in the NSE
      state.  They only apply a fraction (0.3) of the energy release to the internal
      energy in a zone, to avoid a potential instability that can arise if too much
      energy is added to a zone in a single timestep.  We prefer to deal with this
      issue through the retry mechanism already built into \castro.

      The approach we use begins with calling the NSE table with the input state:
      \begin{equation}
        \nse{\rho_\inp, T_\inp, (Y_e)_\inp} \rightarrow \bar{A}^\star, (X_k)^\star, (B/A)^\star, dY_e/dt
        \end{equation}
      We indicate with a $\star$ that most of those values are
      provisional, and we will seek a better value in the corrector step.
      We only update $Y_e$ from this call:
      \begin{equation}
        (Y_e)_\out = (Y_e)_\inp + \Delta t \frac{dY_e}{dt}
      \end{equation}
      and then we use the table again, but with the updated $Y_e$
      (note that $\rho_{\rm out}=\rho_{\rm in}$ in the Strang reaction formulation):
      \begin{equation}
        \nse{\rho_\out, T_\inp, (Y_e)_\out} \rightarrow \bar{A}_\out, (X_k)_\out, (B/A)_\out, dY_e/dt
      \end{equation}
      In this formulation, we have not updated the temperature. \MarginPar{discuss this more, and perhaps switch to a mode where we try to predict T}
      This corrects the composition so that it is consistent with the updated
      $Y_e$.  We use these values $\bar{A}_\out$, $(X_k)_\out$, and $(B/A)_\out$ to then complete the update, computing the energy release, $\Sdot$ as:
      \begin{equation}
        \label{eq:nse_energy}
        \Sdot = \left [ \left ( \frac{B}{A} \right )_\out -
          \left ( \frac{B}{A} \right )_\inp \right ] N_A \frac{1}{\Delta t}
      \end{equation}
      \MarginPar{we could imagine looping over the EOS to get an updated T and then the table to get the updated $\bar{A}$, to see if that converges?}
      
    \item For zones not in NSE:

    \begin{itemize}
    \item Integrate the full reaction network (Eqs.~\ref{eq:strang:T} and \ref{eq:strang:X}) as usual for Strang splitting
    \item Update the aux quantities at the end of the burn using Eqs.~\ref{eq:aux:ye}, \ref{eq:aux:abar}, and \ref{eq:aux:bea} with the new mass fractions, $X_k$.
    \end{itemize}
  \end{itemize}
\end{itemize}

\subsection{SDC-NSE Coupling}

With SDC evolution, when we are in NSE, we need to do the advective
and reactive updates together.  With the tabulated NSE reaction
values, we get instantaneous values of the reaction sources, but the only
time derivative we have is for $Y_e$.  We will
use a basic predictor-corrector update:
\begin{equation}
\Uc^\star = \Uc^n + \Delta t \Adv{\Uc}^{n+1/2} + \Delta t \left [\Rb (\Uc) \right ]^{n+1/2}
\end{equation}
Calling the NSE table on the starting state gives us:
\begin{equation}
\nse{\rho^n, T^n, (Y_e)^n} \rightarrow \bar{A}^n, (X_k)^n, (B/A)^n, (dY_e/dt)^n
\end{equation}
To get the reactive source, we need to use the iteratively-lagged time-centered information
from $\Ic_q^{n+1/2,(k-1)}$.  We only need to update the internal energy and auxiliary data,
since together with the density, that is all that is needed for the equation of state to get the
updated temperature.    So our sources are:
\begin{equation}
R(\rho e) \approx \Ics_q(\rho e)
\end{equation}
and
\begin{equation}
R(\rho \alpha_l) \approx \rho^{n+1/2} \Ics_q(\alpha_l)
\end{equation}
where $\rho^{n+1/2} = (\rho^n + \rho^\star)/2$.

Since we have $(dY_e/dt)^n$ from the table, we replace the source for $Y_e$ in the above
$\Rb(\Uc^n)$ as: \MarginPar{it might be better if we had $\Ics_\Uc$}
\begin{equation}
R(\rho Y_e) = \rho^{n+1/2} (dY_e/dt)^n
\end{equation}
which gives an update for the electron fraction as:
\begin{equation}
(\rho Y_e)^\star = (\rho Y_e)^n + \Delta t \Advss{\rho Y_e}^{n+1/2} + \Delta t \rho^{n+1/2} (dY_e/dt)^n
\end{equation}
We can then get $\alpha_l^\star = (\rho \alpha_l)^\star/\rho^\star$.
From this prediction, we get $\rho^\star$, $\alpha_l^\star$, and
$e^\star$, which allows us to call the EOS and get an updated
temperature, $T^\star$. \MarginPar{Andy suggests time-centering $dY_e/dt$}
\begin{equation}
T^\star = T(\rho^\star, \alpha_l^\star, e^\star)
\end{equation}
We can then again call the NSE table:
\begin{equation}
\nse{\rho^\star, T^\star, (Y_e)^\star} \rightarrow \bar{A}^{n+1,(k)}, (X_k)^{n+1,(k)}, (B/A)^{n+1,(k)}, (dY_e/dt)
\end{equation}
where we use the outputs to define the new values of the composition variables.
Since the density and momenta don't have reactive sources, we just use the $\Uc^\star$ state
as their new values:
\begin{align}
\rho^{n+1,(k)} &= \rho^\star \\
(\rho u)^{n+1,(k)} &= (\rho u)^\star
\end{align}
We then compute the energy release as
\begin{equation}
       (\rho \Sdot)^{n+1/2} = \frac{\rho^{n+1,(k)} + \rho^n}{2}
             \left [ \left ( \frac{B}{A} \right )^{n+1,(k)} -
                     \left ( \frac{B}{A} \right )^n \right ] N_A \frac{1}{\Delta t}
\end{equation}

{\color{red}
Note I tried this first, but it really doesn't work.  I'd like to understand better:
\begin{equation}
       (\rho \Sdot)^{n+1/2} = \left [ \rho^{n+1,(k)} \left ( \frac{B}{A} \right )^{n+1,(k)} -
                            \rho^n \left ( \frac{B}{A} \right )^n \right ] N_A \frac{1}{\Delta }t
\end{equation}
}
and then do the final update of the total energy:
\begin{equation}
(\rho E)^{n+1,(k)} = (\rho E)^n + \Delta t \Advss{\rho E}^{n+1/2} + \Delta t (\rho \Sdot)^{n+1/2}
\end{equation}

\section{Simulations}

\subsection{Reacting convergence test problem}

\cite{castro_sdc} introduced a test problem for measuring convergence
of a reacting hydrodynamic algorithm.  We run that same test here with the
simplified SDC algorithm.

Also explore: PLM vs PPM, 1 vs. 2 vs. 3 iterations

\begin{deluxetable}{lllllll}
\tablecaption{\label{table:react_convert_strang} Convergence ($L_1$ norm) for the reacting convergence problem using Strang splitting.}
\tablehead{\colhead{field} & \colhead{$\epsilon_{64 \rightarrow 128}$} & 
           \colhead{rate} & \colhead{$\epsilon_{128\rightarrow 256}$} & 
           \colhead{rate} & \colhead{$\epsilon_{256\rightarrow 512}$}}
\startdata
 $\rho$                      & $2.781 \times 10^{18}$  & 2.051  & $6.711 \times 10^{17}$  & 2.580  & $1.122 \times 10^{17}$  \\
 $\rho u$                    & $6.781 \times 10^{26}$  & 2.445  & $1.245 \times 10^{26}$  & 2.907  & $1.659 \times 10^{25}$  \\
 $\rho v$                    & $6.781 \times 10^{26}$  & 2.445  & $1.245 \times 10^{26}$  & 2.907  & $1.659 \times 10^{25}$  \\
 $\rho E$                    & $2.465 \times 10^{35}$  & 2.333  & $4.892 \times 10^{34}$  & 2.650  & $7.794 \times 10^{33}$  \\
 $\rho e$                    & $2.268 \times 10^{35}$  & 2.298  & $4.610 \times 10^{34}$  & 2.722  & $6.988 \times 10^{33}$  \\
 $T$                         & $2.248 \times 10^{21}$  & 1.682  & $7.003 \times 10^{20}$  & 2.439  & $1.291 \times 10^{20}$  \\
 $\rho X(\isotm{He}{4})$     & $2.862 \times 10^{18}$  & 2.027  & $7.023 \times 10^{17}$  & 2.554  & $1.196 \times 10^{17}$  \\
 $\rho X(\isotm{C}{12})$     & $1.717 \times 10^{17}$  & 1.945  & $4.460 \times 10^{16}$  & 2.194  & $9.745 \times 10^{15}$  \\
 $\rho X(\isotm{O}{16})$     & $1.718 \times 10^{14}$  & 1.648  & $5.482 \times 10^{13}$  & 1.898  & $1.471 \times 10^{13}$  \\
 $\rho X(\isotm{Fe}{56})$    & $2.781 \times 10^{8}$   & 2.051  & $6.711 \times 10^{7}$   & 2.580  & $1.122 \times 10^{7}$   \\
\enddata
\end{deluxetable}

\begin{deluxetable}{lllllll}
\tablecaption{\label{table:react_convert_strang} Convergence ($L_1$ norm) for the reacting convergence problem using Strang splitting with $T$ evolution disabled.}
\tablehead{\colhead{field} & \colhead{$\epsilon_{64 \rightarrow 128}$} & 
           \colhead{rate} & \colhead{$\epsilon_{128\rightarrow 256}$} & 
           \colhead{rate} & \colhead{$\epsilon_{256\rightarrow 512}$}}
\startdata
 $\rho$                      & $2.735 \times 10^{18}$  & 2.057  & $6.571 \times 10^{17}$  & 2.474  & $1.183 \times 10^{17}$  \\
 $\rho u$                    & $6.729 \times 10^{26}$  & 2.416  & $1.260 \times 10^{26}$  & 2.699  & $1.941 \times 10^{25}$  \\
 $\rho v$                    & $6.729 \times 10^{26}$  & 2.416  & $1.260 \times 10^{26}$  & 2.699  & $1.941 \times 10^{25}$  \\
 $\rho E$                    & $2.513 \times 10^{35}$  & 2.226  & $5.372 \times 10^{34}$  & 2.169  & $1.195 \times 10^{34}$  \\
 $\rho e$                    & $2.292 \times 10^{35}$  & 2.194  & $5.011 \times 10^{34}$  & 2.253  & $1.051 \times 10^{34}$  \\
 $T$                         & $2.321 \times 10^{21}$  & 1.606  & $7.623 \times 10^{20}$  & 1.993  & $1.915 \times 10^{20}$  \\
 $\rho X(\isotm{He}{4})$     & $2.806 \times 10^{18}$  & 2.028  & $6.880 \times 10^{17}$  & 2.432  & $1.275 \times 10^{17}$  \\
 $\rho X(\isotm{C}{12})$     & $1.807 \times 10^{17}$  & 1.846  & $5.026 \times 10^{16}$  & 1.605  & $1.653 \times 10^{16}$  \\
 $\rho X(\isotm{O}{16})$     & $1.905 \times 10^{14}$  & 1.500  & $6.737 \times 10^{13}$  & 1.439  & $2.484 \times 10^{13}$  \\
 $\rho X(\isotm{Fe}{56})$    & $2.735 \times 10^{8}$   & 2.057  & $6.571 \times 10^{7}$   & 2.474  & $1.183 \times 10^{7}$   \\
\enddata
\end{deluxetable}


% run on 12-31-20
% Castro: 20.12-80-gfe3e9c8de8
\begin{deluxetable}{lllllll}
\tablecaption{\label{table:react_convert_strang} Convergence ($L_1$ norm) for the reacting convergence problem using SDC integration (2 iterations).}
\tablehead{\colhead{field} & \colhead{$\epsilon_{64 \rightarrow 128}$} & 
           \colhead{rate} & \colhead{$\epsilon_{128\rightarrow 256}$} & 
           \colhead{rate} & \colhead{$\epsilon_{256\rightarrow 512}$}}
\startdata
 $\rho$                      & $2.794 \times 10^{18}$  & 2.047  & $6.760 \times 10^{17}$  & 2.563  & $1.144 \times 10^{17}$  \\
 $\rho u$                    & $6.796 \times 10^{26}$  & 2.450  & $1.243 \times 10^{26}$  & 2.898  & $1.669 \times 10^{25}$  \\
 $\rho v$                    & $6.796 \times 10^{26}$  & 2.450  & $1.243 \times 10^{26}$  & 2.898  & $1.669 \times 10^{25}$  \\
 $\rho E$                    & $2.450 \times 10^{35}$  & 2.357  & $4.783 \times 10^{34}$  & 2.743  & $7.144 \times 10^{33}$  \\
 $\rho e$                    & $2.261 \times 10^{35}$  & 2.325  & $4.513 \times 10^{34}$  & 2.821  & $6.385 \times 10^{33}$  \\
 $T$                         & $2.236 \times 10^{21}$  & 1.690  & $6.929 \times 10^{20}$  & 2.473  & $1.248 \times 10^{20}$  \\
 $\rho X(\isotm{He}{4})$     & $2.877 \times 10^{18}$  & 2.023  & $7.078 \times 10^{17}$  & 2.536  & $1.220 \times 10^{17}$  \\
 $\rho X(\isotm{C}{12})$     & $1.697 \times 10^{17}$  & 1.947  & $4.402 \times 10^{16}$  & 2.222  & $9.436 \times 10^{15}$  \\
 $\rho X(\isotm{O}{16})$     & $1.688 \times 10^{14}$  & 1.658  & $5.349 \times 10^{13}$  & 1.950  & $1.385 \times 10^{13}$  \\
 $\rho X(\isotm{Fe}{56})$    & $2.794 \times 10^{8}$   & 2.047  & $6.760 \times 10^{7}$   & 2.563  & $1.144 \times 10^{7}$   \\
\enddata
\end{deluxetable}


\subsection{NSE convergence test problem}

To test the coupling of the NSE table to the hydrodynamics, we run a
similar problem as above, except with the thermodynamic conditions
appropriate for the matter to be in NSE.  The initial conditions are:
\begin{align}
\rho &= \rho_0 \\
T &= T_0 \left [ 1 + (\delta T) e^{-(r/\lambda)^2} \cos^6(\pi r/L) \right ] \\
Y_e &= (Y_e)_0 \left [ 1 + (\delta Y_e) e^{-(r/\lambda)^2} \cos^6(\pi r/L) \right ] 
\end{align}
where $r$ is the distance from the center of the domain and the
remaining parameters are listed in Table~\ref{table:nse}.  This has
$Y_e$ varying between $[0.47, 0.5]$ initially\MarginPar{check}.  The mass fractions
and remaining composition variables are then initialized from the NSE table, as described in section~\ref{sec:initialization}.

The domain has a size $[0, L]^2$, and the timestep is fixed as:
\begin{equation}
\Delta t = 10^{-3} \left ( \frac{64}{N} \right )~\mathrm{s}
\end{equation}
where $N$ is the number of zones in each direction.

\begin{deluxetable}{lcc}
\tablecaption{\label{table:nse} NSE convergence test problem.}
\tablehead{\colhead{parameter} & \colhead{value}}
\startdata
$\rho_0$ & $5\times 10^8~\gcc$ \\
$T_0$    & $4\times 10^9~\mathrm{K}$ \\
$(\delta T)$ & $0.2$ \\
$(Y_e)_0$   & $0.5$ \\
$(\delta Y_e)$ & $-0.05$ \\
$\lambda$   & $2\times 10^7~\mathrm{cm}$ \\
$L$         & $10^8~\mathrm{cm}$ \\
\enddata
\end{deluxetable}

Figure~\ref{fig:nse_ye} shows the $Y_e$ profile for the Strang evolution case.

\begin{figure}[t]
\centering
\plotone{ye_plot}
\caption{\label{fig:nse_ye} Profile of $Y_e$ through the middle of the domain (slicing along $x$)
for the $128^2$ Strang NSE test simulation.}
\end{figure}



\begin{deluxetable}{lllllll}
\tablecaption{\label{table:nse_strang_methodII} Convergence ($L_1$ norm) for the NSE convergence
problem using Strang splitting.}
\tablehead{\colhead{field} & \colhead{$\epsilon_{64 \rightarrow 128}$} & 
           \colhead{rate} & \colhead{$\epsilon_{128\rightarrow 256}$} & 
           \colhead{rate} & \colhead{$\epsilon_{256\rightarrow 512}$}}
\startdata
 $\rho$                      & $4.522 \times 10^{19}$  & 1.659  & $1.432 \times 10^{19}$  & 1.542  & $4.917 \times 10^{18}$  \\
 $\rho u$                    & $1.883 \times 10^{28}$  & 1.681  & $5.873 \times 10^{27}$  & 1.524  & $2.042 \times 10^{27}$  \\
 $\rho v$                    & $1.883 \times 10^{28}$  & 1.681  & $5.873 \times 10^{27}$  & 1.524  & $2.042 \times 10^{27}$  \\
 $\rho E$                    & $5.933 \times 10^{37}$  & 1.613  & $1.940 \times 10^{37}$  & 1.411  & $7.293 \times 10^{36}$  \\
 $\rho e$                    & $5.931 \times 10^{37}$  & 1.613  & $1.939 \times 10^{37}$  & 1.411  & $7.291 \times 10^{36}$  \\
 $T$                         & $9.885 \times 10^{20}$  & 1.207  & $4.281 \times 10^{20}$  & 1.058  & $2.057 \times 10^{20}$  \\
 $\rho X(\isotm{He}{4})$     & $5.086 \times 10^{17}$  & 1.430  & $1.887 \times 10^{17}$  & 1.187  & $8.288 \times 10^{16}$  \\
 $\rho X(\isotm{C}{12})$     & $1.585 \times 10^{12}$  & 1.829  & $4.462 \times 10^{11}$  & 1.433  & $1.652 \times 10^{11}$  \\
 $\rho X(\isotm{O}{16})$     & $8.060 \times 10^{12}$  & 1.706  & $2.470 \times 10^{12}$  & 1.347  & $9.710 \times 10^{11}$  \\
 $\rho X(\isotm{Cr}{48})$    & $1.149 \times 10^{19}$  & 1.400  & $4.353 \times 10^{18}$  & 1.258  & $1.820 \times 10^{18}$  \\
 $\rho X(\isotm{Fe}{52})$    & $9.018 \times 10^{19}$  & 1.173  & $4.001 \times 10^{19}$  & 1.127  & $1.832 \times 10^{19}$  \\
 $\rho X(\isotm{Fe}{54})$    & $5.036 \times 10^{20}$  & 1.731  & $1.517 \times 10^{20}$  & 1.727  & $4.582 \times 10^{19}$  \\
 $\rho X(\isotm{Ni}{56})$    & $5.686 \times 10^{20}$  & 1.622  & $1.847 \times 10^{20}$  & 1.563  & $6.252 \times 10^{19}$  \\
 $\rho Y_e$                  & $2.379 \times 10^{19}$  & 1.678  & $7.431 \times 10^{18}$  & 1.578  & $2.489 \times 10^{18}$  \\
 $\rho \bar{A}$              & $5.141 \times 10^{21}$  & 1.230  & $2.191 \times 10^{21}$  & 1.087  & $1.032 \times 10^{21}$  \\
 $\rho (B/A)$                & $4.149 \times 10^{20}$  & 1.693  & $1.283 \times 10^{20}$  & 1.562  & $4.345 \times 10^{19}$  \\
\enddata
\end{deluxetable}


\begin{deluxetable}{lllllll}
\tablecaption{\label{table:nse_strang_methodII} Convergence ($L_1$ norm) for the NSE convergence
problem using the simplified-SDC algorithm.}
\tablehead{\colhead{field} & \colhead{$\epsilon_{64 \rightarrow 128}$} & 
           \colhead{rate} & \colhead{$\epsilon_{128\rightarrow 256}$} & 
           \colhead{rate} & \colhead{$\epsilon_{256\rightarrow 512}$}}
\startdata
 $\rho$                      & $4.558 \times 10^{19}$  & 1.633  & $1.470 \times 10^{19}$  & 1.578  & $4.923 \times 10^{18}$  \\
 $\rho u$                    & $1.945 \times 10^{28}$  & 1.648  & $6.208 \times 10^{27}$  & 1.513  & $2.176 \times 10^{27}$  \\
 $\rho v$                    & $1.945 \times 10^{28}$  & 1.648  & $6.208 \times 10^{27}$  & 1.513  & $2.176 \times 10^{27}$  \\
 $\rho E$                    & $5.710 \times 10^{37}$  & 1.620  & $1.857 \times 10^{37}$  & 1.552  & $6.333 \times 10^{36}$  \\
 $\rho e$                    & $5.708 \times 10^{37}$  & 1.620  & $1.857 \times 10^{37}$  & 1.553  & $6.331 \times 10^{36}$  \\
 $T$                         & $5.873 \times 10^{20}$  & 1.621  & $1.910 \times 10^{20}$  & 1.494  & $6.779 \times 10^{19}$  \\
 $\rho X(\isotm{He}{4})$     & $2.453 \times 10^{17}$  & 1.835  & $6.876 \times 10^{16}$  & 1.657  & $2.181 \times 10^{16}$  \\
 $\rho X(\isotm{C}{12})$     & $1.130 \times 10^{12}$  & 1.846  & $3.145 \times 10^{11}$  & 1.678  & $9.831 \times 10^{10}$  \\
 $\rho X(\isotm{O}{16})$     & $5.339 \times 10^{12}$  & 1.830  & $1.502 \times 10^{12}$  & 1.667  & $4.730 \times 10^{11}$  \\
 $\rho X(\isotm{Cr}{48})$    & $6.880 \times 10^{18}$  & 1.791  & $1.988 \times 10^{18}$  & 1.601  & $6.554 \times 10^{17}$  \\
 $\rho X(\isotm{Fe}{52})$    & $3.470 \times 10^{19}$  & 1.606  & $1.140 \times 10^{19}$  & 1.608  & $3.740 \times 10^{18}$  \\
 $\rho X(\isotm{Fe}{54})$    & $4.766 \times 10^{20}$  & 1.764  & $1.403 \times 10^{20}$  & 1.777  & $4.093 \times 10^{19}$  \\
 $\rho X(\isotm{Ni}{56})$    & $4.835 \times 10^{20}$  & 1.781  & $1.407 \times 10^{20}$  & 1.788  & $4.075 \times 10^{19}$  \\
 $\rho Y_e$                  & $2.370 \times 10^{19}$  & 1.644  & $7.582 \times 10^{18}$  & 1.580  & $2.536 \times 10^{18}$  \\
 $\rho \bar{A}$              & $4.061 \times 10^{21}$  & 1.678  & $1.270 \times 10^{21}$  & 1.675  & $3.975 \times 10^{20}$  \\
 $\rho (B/A)$                & $4.224 \times 10^{20}$  & 1.664  & $1.333 \times 10^{20}$  & 1.602  & $4.391 \times 10^{19}$  \\
\enddata
\end{deluxetable}



\subsection{Detonation}

The purpose here is to look at what timestep is taken when we use the nuclear burning limiters.
Run with aprox19 only, Strang and SDC, then aprox19 + NSE, Strang and NSE.

Look at number of SDC iterations too.

How does the timestep limiter work in the middle of SDC iterating?

aprox21

look at number of RHS calls, wallclock time

output every step and then for a single zone plot enuc every timestep to see if it oscillates



\subsection{Massive Star}

Play around with the threshold where NSE kicks in

\section{Summary}

We presented a simplified spectral deferred corrections scheme for coupling
hydrodynamics and reactions.

Future work is to extend this methodology to MHD.



\acknowledgements \castro\ is freely available at
\url{http://github.com/AMReX-Astro/Castro}.  All of the code and
problem setups used here are available in the git repo.  The work at
Stony Brook was supported by DOE/Office of Nuclear Physics grant
DE-FG02-87ER40317.  This material is based upon work supported by the
U.S. Department of Energy, Office of Science, Office of Advanced
Scientific Computing Research and Office of Nuclear Physics,
Scientific Discovery through Advanced Computing (SciDAC) program under
Award Number DE-SC0017955.  This research was supported by the
Exascale Computing Project (17-SC-20-SC), a collaborative effort of
the U.S. Department of Energy Office of Science and the National
Nuclear Security Administration.

\software{\amrex\ \citep{amrex_joss},
          \castro\ \citep{castro},
          GNU Compiler Collection (\url{https://gcc.gnu.org/}),
          Linux (\url{https://www.kernel.org}),
          matplotlib (\citealt{Hunter:2007},  \url{http://matplotlib.org/})
          NumPy \citep{numpy,numpy2},
          python (\url{https://www.python.org/}), 
          SymPy \citep{sympy}
         }



\appendix

\section{Jacobian}

\label{sec:app:jacobian}

To solve the reaction system implicitly, the ODE solver needs the Jacobian,
$\partial \Rb/\partial \Uc$.  We follow the method of \cite{castro_sdc}
and factor this into two pieces,
\begin{equation}
{\bf J} = \frac{\partial \Rb}{\partial {\bf w }} \frac{\partial {\bf w}}{\partial \Uc}.
\end{equation}

Even though it has no reactive sources, we include $\rho$ in our conservative state
for the purposes of computing the Jacobian (we denote the conserved state used for the
Jacobian $\Uc^\prime$).
Writing this out for two species, $X_\alpha$ and $X_\beta$, we have
\begin{equation}
\Uc^\prime = \left ( \begin{array}{c} \rho \\ \rho X_\alpha \\ \rho X_\beta \\ \rho E \\ \rho e \end{array} \right )
\end{equation}
We take the intermediate state to be ${\bf w} = (\rho, X_\alpha, X_\beta,
K, T)^\intercal$, where $K$ is the kinetic energy:
\begin{equation}
K = \frac{1}{2} u^2
\end{equation}

The Jacobian transformation $\partial \Uc^\prime/\partial {\bf w}$ is:
\begin{equation}
\frac{\partial \Uc}{\partial {\bf w}} = \left (
   \begin{array}{ccccc}
       1 & 0 & 0 & 0 & 0 \\
       X_\alpha & \rho & 0 & 0 & 0 \\
       X_\beta & 0 & \rho & 0 & 0  \\
       \rho e_\rho  + e + K &
                 \rho  e_{X_\alpha} & \rho e_{X_\beta} & \rho &
                 \rho e_T \\
       \rho e_\rho  + e  &
                 \rho  e_{X_\alpha} & \rho e_{X_\beta} & 0 &
                 \rho e_T
     \end{array}\right)
\end{equation}
where we use the following notation for compactness:
\begin{equation}
e_\rho = \dedrd \qquad
e_T = \dedTd \qquad
e_{X_k} = \dedXd
\end{equation}
and write the kinetic energy as $K = u^2/2$.  We get the inverse
(computed via SymPy, see the included Jupyter notebook) is:

\begin{equation}
\renewcommand{\arraystretch}{1.5}
\frac{\partial {\bf w}}{\partial \Uc^\prime} = \left (
  \begin{array}{ccccc}
   1  & 0 & 0 & 0 & 0 \\
   - \frac{X_\alpha}{\rho} & \frac{1}{\rho} & 0 & 0 & 0 \\
   - \frac{X_\beta}{\rho} & 0 & \frac{1}{\rho} & 0 & 0 \\
   - \frac{K}{\rho} & 0 & 0 & \frac{1}{\rho} & -\frac{1}{\rho} \\
   \frac{\sum_k X_{k} e_{X_k} - \rho e_\rho - e}{ \rho e_T} &
    -\frac{e_{X_\alpha}}{\rho e_T} & -\frac{e_{X_\beta}}{\rho e_T} & 0 & \frac{1}{\rho e_T} \\
   \end{array}\right)
\renewcommand{\arraystretch}{1}
\end{equation}

The reaction vector is
\begin{equation}
\Rb(\Uc^\prime) = \left (  \begin{array}{c} 0 \\ \rho \omegadot_\alpha \\ \rho \omegadot_\beta \\ \rho \Sdot \\ \rho \Sdot \end{array} \right )
\end{equation}
and the Jacobian is computed as $\partial \Rb/\partial {\bf w}$:
\begin{equation}
\frac{\partial \Rb}{\partial {\bf w}} = \left (
  \begin{array}{ccccc}
     0 & 0 & 0 & 0 & 0 \\
     \omegadot_\alpha + \rho \frac{\partial \omegadot_\alpha}{\partial \rho} &
     \rho \frac{\partial \omegadot_\alpha}{\partial X_\alpha} &
     \rho \frac{\partial \omegadot_\alpha}{\partial X_\beta} & 0 & \rho \frac{\partial \omegadot_\alpha}{\partial T} \\
      %
     \omegadot_\beta + \rho \frac{\partial \omegadot_\beta}{\partial \rho} &
     \rho \frac{\partial \omegadot_\beta}{\partial X_\alpha} &
     \rho \frac{\partial \omegadot_\beta}{\partial X_\beta} & 0 &  \rho \frac{\partial \omegadot_\beta}{\partial T} \\
     %
     \Sdot + \rho \frac{\partial \Sdot}{\partial \rho} & \rho \frac{\partial \Sdot}{\partial X_\alpha} & \rho \frac{\partial \Sdot}{\partial X_\beta} & 0 & \rho \frac{\partial \Sdot}{\partial T} \\
     %
     \Sdot + \rho \frac{\partial \Sdot}{\partial \rho} & \rho \frac{\partial \Sdot}{\partial X_\alpha} & \rho \frac{\partial \Sdot}{\partial X_\beta} & 0 & \rho \frac{\partial \Sdot}{\partial T} \\
  \end{array}
  \right )
\end{equation}



%======================================================================
% References
%======================================================================

\bibliographystyle{aasjournal}
\bibliography{ws}

\end{document}
