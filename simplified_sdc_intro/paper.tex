\documentclass[times,modern]{aastex63}

% these lines seem necessary for pdflatex to get the paper size right
\pdfpagewidth 8.5in
\pdfpageheight 11.0in

\usepackage[T1]{fontenc}
\usepackage{epsf,color,amsmath}

\usepackage{cancel}

\newcommand{\sfrac}[2]{\mathchoice%
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
    \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
    \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptscriptfont0 #1}\kern-.2em/
    \kern-.15em\lower.25ex\hbox{\the\scriptscriptfont0 #2}} {#1\!/#2}}


\newcommand{\castro}{{\sf Castro}}
\newcommand{\maestro}{{\sf Maestro}}
\newcommand{\flash}{{\sf Flash}}
\newcommand{\amrex}{{\sf AMReX}}

\newcommand{\isot}[2]{$^{#2}\mathrm{#1}$}
\newcommand{\isotm}[2]{{}^{#2}\mathrm{#1}}

\newcommand{\gcc}{\mathrm{g~cm^{-3} }}
\newcommand{\cms}{\mathrm{cm~s^{-1} }}

\newcommand{\nablab}{{\mathbf{\nabla}}}
\newcommand{\Ub}{\mathbf{U}}
\newcommand{\gb}{\mathbf{g}}
\newcommand{\omegadot}{\dot{\omega}}
\newcommand{\Sdot}{\dot{S}}
\newcommand{\ddx}[1]{{\frac{{\partial#1}}{\partial x}}}
\newcommand{\ddt}[1]{{\frac{{\partial#1}}{\partial t}}}
\newcommand{\odt}[1]{{\frac{{d#1}}{dt}}}
\newcommand{\divg}[1]{{\nablab \cdot \left (#1\right)}}
\newcommand{\inp}{{\mathrm{input}}}
\newcommand{\dedr}{\left . {\partial{}e}/{\partial\rho}\right |_{T, X_k}}
\newcommand{\dedrd}{\left . \frac{\partial{}e}{\partial\rho}\right |_{T, X_k}}
\newcommand{\dedX}{\left . {\partial{}e}/{\partial{}X_k} \right |_{\rho, T}}
\newcommand{\dedXd}{\left . \frac{\partial{}e}{\partial{}X_k} \right |_{\rho, T, X_{j,j\ne k}}}
\newcommand{\dedT}{\left . {\partial{}e}/{\partial{}T} \right |_{\rho,X_k}}
\newcommand{\dedTd}{\left . \frac{\partial{}e}{\partial{}T} \right |_{\rho,X_k}}

\newcommand{\Ic}{{\boldsymbol{\mathcal{I}}}}
\newcommand{\smax}{{s_\mathrm{max}}}
\newcommand{\kth}{k_\mathrm{th}}
\usepackage{bm}

\newcommand{\Uc}{{\,\bm{\mathcal{U}}}}
\newcommand{\Fb}{\mathbf{F}}
\newcommand{\Sc}{\mathbf{S}}

\newcommand{\xv}{{(x)}}
\newcommand{\yv}{{(y)}}
\newcommand{\zv}{{(z)}}

\newcommand{\ex}{{\bf e}_x}
\newcommand{\ey}{{\bf e}_y}
\newcommand{\ez}{{\bf e}_z}

\newcommand{\Ab}{{\bf A}}
\newcommand{\Sq}{{\bf S}_\qb}
\newcommand{\Sqhydro}{{\Sq^{\mathrm{hydro}}}}
\newcommand{\qb}{{\bf q}}

\newcommand{\Shydro}{{{\bf H}}}
\newcommand{\Hb}{{\bf H}}
\newcommand{\Rb}{{\bf R}}
\newcommand{\Rq}{{\bf R}}
\newcommand{\Adv}[1]{{\left [\boldsymbol{\mathcal{A}} \left(#1\right)\right]}}
\newcommand{\Advt}[1]{{\left [\boldsymbol{\mathcal{\tilde{A}}} \left(#1\right)\right]}}
\newcommand{\Advs}[1]{\boldsymbol{\mathcal{A}} \left(#1\right)}

\newcommand{\avg}[1]{{\left \langle #1 \right \rangle}}

\setlength{\marginparwidth}{0.75in}
\newcommand{\MarginPar}[1]{\marginpar{\vskip-\baselineskip\raggedright\tiny\sffamily\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\begin{document}
%======================================================================
% Title
%======================================================================
\title{A Simplified Spectral Deferred Correction Method for Coupling Hydrodynamics with Reaction Networks and Nuclear Statistical Equilibrium}

\shorttitle{A Simplified SDC Method}
\shortauthors{}

%% \author[0000-0001-8401-030X]{M.~Zingale}
%% \affiliation{Dept.\ of Physics and Astronomy, Stony Brook University,
%%        Stony Brook, NY 11794-3800}

%% \author[0000-0003-0439-4556]{M.~P.~Katz}
%% \affiliation{Nvidia Corp}

%% \author[0000-0002-5749-334X]{J.~B.~Bell}
%% \affiliation{Center for Computational Sciences and Engineering, Lawrence Berkeley National Laboratory, Berkeley, CA  94720}

%% \author[0000-0003-1791-0265]{A.~J.~Nonaka}
%% \affiliation{Center for Computational Sciences and Engineering, Lawrence Berkeley National Laboratory, Berkeley, CA  94720}

%% \author[0000-0001-8092-1974]{W.~Zhang}
%% \affiliation{Center for Computational Sciences and Engineering, Lawrence Berkeley National Laboratory, Berkeley, CA  94720}

%% \correspondingauthor{Michael Zingale}
%% \email{michael.zingale@stonybrook.edu}


%======================================================================
% Abstract and Keywords
%======================================================================
\begin{abstract}
Reacting astrophysical flows can be challenging to model because of
the difficulty in accurately coupling hydrodynamics and reactions.
This can be particularly acute at high temperatures where nuclear
statistical equilibrium is established.  We develop a simplified
approach to spectral deferred corrections (SDC) coupling of explicit
hydrodynamics and stiff reaction sources as an alternative to operator
splitting or the more comprehensive SDC approach we demonstrated
previously.  We apply the new method some example problems and show
how to modify it to work with a hybrid network consisting of a
reaction ODE system and a table for nuclear statistical equilibrium.
This is all done in the framework of the \castro\ hydrodynamics code,
and all algorithm implementations are freely available.
\end{abstract}

\keywords{hydrodynamics---methods: numerical}

%======================================================================
% Introduction
%======================================================================
\section{Introduction}\label{Sec:Introduction}

Reactive flow can be challenging to model when the timescale for
changes in the nuclear abundances due to reactions is comparable to
the hydrodynamical timescales.  Traditional methods of coupling
hydrodynamics and reactions used in astrophysics use operator
splitting---each physical process acts on the output of the previous
process.  This makes it easy to add physics in a modular way to a
simulation code, but competition between physical processes can cause
the coupling to breakdown.  In general, the error in the splitting
controlled by the timestep.

A particular difficult phase of evolution to model is the nuclear
statistic equilibrium that sets in with helium burning for
temperatures in excess of $4\times 10^9~\mathrm{K}$.  Physically, the
forward and reverse rates should balance leading to an equilibrium.
With operator splitting, an NSE region will have a large positive flow
through the network in a zone in one step followed by a large negative
flow over the next timestep, as the code struggles to produce an
equilibrium.  This large change in abundances (and large alternately
positive and negative energy generation rates) can be a challenge for
a code.  The easiest way to improve the coupling is to cut the
timestep, but this makes simulations prohibitively expensive.
Sometimes the burning is simply halted on a zone-by-zone basis when
NSE conditions are reached (e.g., as in \citealt{hedet}).
Alternately, at high temperatures, a reaction network can be replaced
with a table of NSE abundances and the zone's composition set through
table look-ups (e.g.\ \citealt{ma:2013}) \MarginPar{need more here}

In \cite{castro_sdc}, we developed second- and fourth-order accurate
methods in space and time for coupling hydrodynamics and nuclear
reaction networks based on spectral deferred corrections (SDC)
methods, and demonstrated the method of a variety of test problems.
The approach presented here is considerably simpler, reusing the main
CTU hydrodynamics construction and a largely similar ODE integration
scheme, making this method easier to add to existing simulation codes.
However, it is restricted to second-order accuracy overall.  We term
this algorithm the ``simplified SDC method''.  We use the
\castro\ hydrodynamics code \cite{castro} for all of our numerical
experiments, and all of the code to reproduce the results in this
paper are in the \castro\ github
repository\footnote{\url{https://github.com/amrex-astro/Castro/}}.

\section{Numerical Methodology}


We solve the Euler equations for compressible, reacting flow.  We'll
focus on one-dimensional flow for this description, and the system
appears as:
\begin{equation}
\frac{\partial \Uc_t}{\partial t}  + \frac{\partial \Fb^\xv (\Uc)}{\partial x} = \Sc(\Uc)
\end{equation}
where
\begin{equation}
\Uc = \left ( \begin{array}{c}
           \rho \\
           \rho X_k \\
           \rho u \\
           \rho E \end{array}\right )
\end{equation}
are the conserved fluid quantities: mass density, $\rho$, velocity, $u$,
specific total energy, $E$, and nuclear
species mass fractions, $X_k$.  The specific total energy relates to
the specific internal energy as $E = e + u^2/2$.  The
corresponding fluxes are
\begin{equation}
\Fb^\xv (\Uc) = \left ( \begin{array}{c}
   \rho u \\ \rho X_k u \\ \rho u u + p \\  \rho u E + u p
   \end{array} \right )
\end{equation}
Here the pressure, $p$, enters, and is found via the equation of state,
\begin{equation}
p = p(\rho, X_k, e)
\end{equation}


We decompose the source terms, $\Sc(\Uc)$, into
hydrodynamical sources, $\Hb$ (like gravity), and reactive sources,
$\Rb$,
\begin{equation}
  \Sc(\Uc) = \Hb(\Uc) + \Rb(\Uc)
\end{equation}
 The reactive
sources take the form:
\begin{equation}
  \Rb(\Uc) = \left ( \begin{array}{c}
     0 \\ \rho \omegadot_k \\ 0 \\ \rho \dot{S}
  \end{array} \right )
\end{equation}
where $\omegadot_k$ is the creation rate for species $k$ and $\dot{S}$
is the energy generation rate per unit mass.

Sometimes it is preferable to work with the primitive variables,
\begin{equation}
\qb = \left ( \begin{array}{c}
  \rho \\
  X_k \\
  u \\
  p \\
  (\rho e) \\
\end{array} \right )
\end{equation}
Here, the system appears
as:
\begin{equation}
\qb_t + \Ab^\xv(\qb) \qb_x  = \Sq
\end{equation}
with the matrix $\Ab^\xv$ giving the coefficients of the spatial derivatives
of the primitive variables:
\begin{equation}
\Ab^\xv(\qb) = \left ( \begin{array}{ccccc}
    u & 0 & \rho & 0 & 0 \\
    0 & u & 0    & 0 & 0 \\
    0 & 0 & u    & 1/\rho & 0 \\
    0 & 0 & \Gamma_1 p & u & 0 \\
    0 & 0 & \rho h & 0 & u
  \end{array} \right )
\end{equation}
where $\Gamma_1$ is an adiabatic index, $\Gamma_1 = d\log p/d\log\rho
|_s$.  Note, the primitive state has two thermodynamic quantities, $p$
and $(\rho e)$, to more efficiently handle the general equation of
state in the Riemann solver, as described in \citet{castro}, but
alternate formulations are possible \citep{colellaglaz:1985}.
The source term vector, $\Sq$, can again be decomposed into hydrodynamic
sources (now in terms of the primitive variables) and reaction terms,
\begin{equation}
  \Sq = \Sqhydro + \Rb(q)
\end{equation}
with
\begin{equation}
\Rb(q) = \left ( \begin{array}{c}
     0 \\
     \omegadot_k \\
     0 \\
     \Gamma_1 p \sigma \Sdot \\
     \rho \Sdot
   \end{array} \right )
\end{equation}
where
\begin{equation}
\sigma \equiv \frac{\partial p/\partial T |_\rho}{\rho c_p \partial p/\partial \rho |_T}
\end{equation}
and $c_p$ is the specific heat at constant pressure, $c_p = \partial
h/\partial T |_p$.  A derivation of this source for the pressure
equation can be found in \cite{ABNZ:III}.  We note that this source is
algebraically identical to that shown in Eq.~25 of \cite{castro}.



We use the \castro\ hydrodynamics code~\cite{castro}, together with
the corner transport upwind piecewise parabolic method
hydrodynamics~\citep{millercolella:2002}.  This is a finite-volume
method that uses characteristic tracing to predict a time-centered
flux through the interfaces of the grid zones.  For pure
hydrodynamics, these time-centered fluxes result in second-order
accurate time integration.  With reactions, we want to couple
hydrodynamics and the reaction sources to second order.  Nuclear
reaction sources are stiff, and need to be integrated using implicit
methods for stabilty.  Operator splitting is traditionally employed
here, and we compare to it in this paper.



\subsection{Strang Splitting}

In Strang splitting, we first evolve the system without advection
through $\Delta t/2$, then do the advective update without reactions
through $\Delta t$, and finally do the last reactive update through $\Delta t/2$.

In the absence of advective terms, our reaction system appears as just
$d\Uc/dt = \Rb(\Uc)$, or:
\begin{align}
\odt{\rho} & = 0 \\
\odt{(\rho X_k)} &= \rho \omegadot_k \\
\odt{(\rho u)} &= 0 \\
\odt{(\rho E)} &= \rho \Sdot
\end{align}
We can write the energy equation as:
\begin{equation}
\odt{(\rho E)} = \odt{(\rho e)} + \odt{K} = \rho \Sdot
\end{equation}
where $K$ is the kinetic energy, $K = |u|^2/2$.  Since the velocity is
unchanged by reactions, this means that
\begin{equation}
\odt{(\rho e)} = \rho \odt{e} = \rho \Sdot
\end{equation}
The reaction rates are typically expressed as $\omegadot_k(\rho, T,
X_k)$, when we evolve this system.  This requires an EOS inversion to get $T$ from $e$ each
time we need to evaluate the reactive terms.

Normally we want to integrate temperature temperature.  We can write the
energy equation as:
\begin{equation}
\rho \odt{e} = \rho \left [ \underbrace{\left . \frac{\partial e}{\partial T} \right |_\rho}_{c_v}
                            \odt{T} +
                            \left . \frac{\partial e}{\partial \rho} \right |_T
                            \cancelto{0}{\odt{\rho}} \;\; \right ] = \rho \Sdot
\end{equation}
reducing to
\begin{equation}
\label{eq:strang:T}
\odt{T} = \frac{1}{c_v} \Sdot
\end{equation}
We can alternately derive this from an enthalpy equation, which is the
correct formulation when we are at constant pressure, and we get the
same temperature equation but with $c_v$ replaced by $c_p$.
Technically this requires an EOS call to get $c_x$, but if the
specific heat varies slowly, we can freeze it during the reaction
solve or use a Taylor expansion in $T$ to capture slow evolution.

We also typically integrate mass fraction itself, instead of partial
densities:
\begin{equation}
\label{eq:strang:X}
\odt{X_k} = \omegadot_k
\end{equation}
The system of equations \ref{eq:strang:T} and \ref{eq:strang:X} are
solved using an implicit ODE solver designed for stiff systems of
equations.  We use VODE~\citep{vode}.

With Strang splitting, the state can drift significantly off of the
smooth solution to the coupled reactive hydrodynamics equations, as
shown graphically in \cite{astronum:2018} using an earlier version of
the present algorithm.

A variation on Strang splitting called (re-)balanced splitting was
developed in \citet{speth:2013}.


\subsection{Timestep Limiters and Retry Mechanism}

Since this method is based off of the CTU hydrodynamics scheme, it
benefits from the larger timestep that method can take (when done with
full corner coupling) as compared to a method-of-lines approach (see
\citealt{ppmunsplit}).  In addition to the standard CFL timestep
limiter for explicit hydrodynamics, \castro\ can also enforce
timestep limiters based on the energy generation or abundance changes
over a timestep:
\begin{align}
\label{eq:dt:nuce}
\Delta t &\le f_e\, \min_{i} \left\{\frac{e_{i}}{\dot{e}_{i}}\right\} \\
%
\label{eq:dt:nucX}
\Delta t &\le f_X\, \min_{i} \left\{\min_{k,X_k > \epsilon_X}\frac{{X_k}_{i}}{{\omegadot_{k,i}}}\right\}
\end{align}
where $i$ is the zone index and $f_e$ and $f_X$ are runtime parameters
used to control the allowed change, and only species for which $X_k > \epsilon_X$ are considered.

\castro\ has the ability to reject a timestep if it detects a failure
and retry with smaller timesteps (subcycling to make up the original
required timestep).  Among the conditions that can trigger this are
density failing below zero during advection, the ODE integration
failing to converge in the implicit solve, or violation of one of the
timestep limiters during the step.  This means that equations
\ref{eq:dt:nuce} and \ref{eq:dt:nucX} are not reactive, but instead
guaranteed to be met throughout the simulation, because the step is
rejected if they are violated.  The retry mechanism in \castro\ works
with both the Strang and simplified-SDC integration scheme.


\subsection{Spectral Deferred Corrections}

The basic idea of spectral deferred corrections is to express the
update as an integral and divide the time-update into a number of
discrete time nodes.  The integral is then approximated using a
quadrature rule over these time nodes and low order approximations are
used to update the state from one time node to the next.  The method
uses iteration to successively improve the solution and the ultimate
accuracy is determined by the quadrature method used to evaluate the
integral, which is done using an iteratively-lagged solution.

We start by writing our update as:
\begin{equation}
\Uc^{n+1} = \Uc^n + \int_t^{t+\Delta t} \left [ \Advs{\Uc} + \Rb(\Uc) \right ] dt
\end{equation}
For the simplified SDC method we explore here, we will make the
advective term piecewise constant in time, using the value at the
midpoint in time, to achieve second-order accuracy, giving us:
\begin{equation}
\label{eq:integral:simplesdc}
\Uc^{n+1} = \Uc^n + \int_t^{t+\Delta t} \left \{ \Adv{\Uc}^{n+1/2} + \Rb(\Uc) \right \} dt
\end{equation}
This is the approach first shown in \citep{SDC-old}.  A
version of this was also implemented in the \maestro\ low-Mach number
hydrodynamics code some time ago.  A compressible version, for use in
\castro\ is slightly different due to the need to do some operations
on the conserved variable state and some on the primitive variable
state.  We describe the application of this to the equations of
compressible hydrodynamics below.

\begin{itemize}

\item {\em Initialization}

  \begin{itemize}
  \item We need an approximation to how much the reactions alone
    changed the primitive variable state over the timestep, which we
    will denote $\Ic_q$.  Since we do not have any information about
    the current timestep in the first iteration,
    we use the value from the last iteration of the previous timestep:
    \begin{equation}
      \Ic^{n+1/2,(-1)}_{\qb} = \Ic^{n-1/2,(\smax-1)}_{\qb}
    \end{equation}
  %% \item Solve the Poisson problem for the initial gravitational potential:
  %%   \begin{equation}
  %%     \nabla^2 \Phi^n = 4\pi G \rho^n
  %%   \end{equation}

  %% \item Set the first guess at the new time potential as
  %%   $\Phi^{n+1,(0)} = \Phi^n$.

  \end{itemize}

\item {\em Iterate}

  Iterate from $k = 0, \ldots, \smax-1$.  For second-order accuracy,
  $\smax = 2$ is sufficient.  In addition to denoting the time-level
  with a superscript (like $n$ or $n+1$), we'll use a second subscript
  in parentheses to keep track of the iteration.

  \begin{itemize}
  \item {\em Create the advective update term, $\Adv{\Uc}^{n+1/2,(k)}$}

    \begin{itemize}
    \item convert $\Uc \rightarrow \qb$.  This is an algebraic transformation,
      but will require the EOS.

    \item predict $\qb$ to the interfaces at $n+1/2$ using the CTU PPM
      method.  The source terms, $\Sq$, used in the prediction are:
      \begin{equation}
        \Sq = \Sqhydro^{n+1/2} + \Ic_\qb^{n+1/2,(k-1)}
      \end{equation}
      Here we use the iteratively lagged integrals of the primitive variable
      terms accounting only for reactions, $\Ic_\qb^{n+1/2,(k-1)}$, as the
      reactive source.  This is in contrast to Strang-splitting, where no
      explicit reactive source terms are seen by the hydrodynamics update.
      Any hydrodynamic source terms are time-centered
      using the previous iteration:
      \begin{equation}
        \Sqhydro^{n+1/2} = \frac{1}{2} \left ( \Sqhydro^n + \Sqhydro^{n+1,(k-1)} \right )
      \end{equation}

    \item solve the Riemann problem at each interface to get a unique
      conserved state on each interface, $\Uc^{n+1/2,(k)}_{i+1/2}$

    \item construct the advective update terms, first ignoring the hydrodynamics sources:
      $\Advt{\Uc}^{n+1/2,(k)}_{i}$, e.g., as:
      \begin{align}
        \Advt{\Uc}^{n+1/2,(k)}_{i} =
          &- \frac{\Fb^\xv(\Uc^{n+1/2,(k)}_{i+1/2}) - \Fb^\xv(\Uc^{n+1/2,(k)}_{i-1/2})}{\Delta x}
      \end{align}
    Now the conservative hydrodynamics source terms are computed by first updating to the
    new state with advection only\footnote{For a source like gravity, this update can be done first for $\rho$ and then define the new momentum source using $\rho^{\star\star}$ and likewise for energy}, as:
    \begin{equation}
      \Uc^{\star\star} = \Uc^n + \Delta t \Advt{\Uc}^{n+1/2,(k)}
    \end{equation}
    %% first updating the density to the new state with advection only as:
    %% \begin{equation}
    %%   \rho^{\star\star} = \rho^n + \Delta t \Advt{\rho}^{n+1/2,(k)}
    %% \end{equation}
    %% then constructing the momentum source term:
    %% \begin{equation}
    %%   {\bf S}_{\rho\Ub}^{n+1/2} = \frac{1}{2} (\rho^n \gb^n + \rho^{\star\star} \gb^{n+1,(k-1)})
    %% \end{equation}
    %% Then updating the momentum with only advection as:
    %% \begin{equation}
    %%   (\rho \Ub)^{\star\star} = (\rho \Ub)^n + \Delta t \Advt{\rho\Ub}^{n+1/2,(k)} + \Delta t {\bf S}_{\rho\Ub}^{n+1/2}
    %% \end{equation}
    %% and finally constructing the energy source:
    %% \begin{equation}
    %%   S_{\rho E}^{n+1/2} = \frac{1}{2} \left [ (\rho\Ub)^n \cdot \gb^n + (\rho\Ub)^{\star\star} \cdot \gb^{n+1,(k-1)}
    %%     \right ]
    %% \end{equation}

    The final advective update term is then:
    \begin{equation}
      \Adv{\Uc}^{n+1/2,(k)}_{i} = \Advt{\Uc}^{n+1/2,(k)}_{i} + \Shydro^{n+1/2}
    \end{equation}
    with
    \begin{equation}
      \Shydro^{n+1/2} = \left ( \begin{array}{c}
                     0 \\ 0 \\
                    {\bf S}_{\rho\Ub}^{n+1/2} \cdot \ex \\
                    S_{\rho E}^{n+1/2} \end{array} \right )
    \end{equation}

    \MarginPar{if $\Shydro$ depended on the outcome of the burn, we might need to do things differently here}

    \end{itemize}

  \item {\em Update the System Using a Method of Lines Integration}

    We update the state by doing the integral in equation
    \ref{eq:integral:simplesdc}.  Since we are approximating the
    advective term as piecewise constant in time, we can simply use an
    ODE integrator to integrate this, just as we do with the reaction
    system in Strang splitting.  The difference here being that we are
    integrating the conserved variables and the state sees the effect
    of advection as we integrate the reactions.  The ODE form of this
    is
    \begin{equation}
      \odt{\Uc} = \Adv{\Uc}^{n+1,(k)} + \Rb(\Uc)
    \end{equation}

    As we are integrating this system we need to get the
    temperature, $T$, for the rate evaluations.  We construct this
    by subtracting the kinetic energy from the total energy to get
    the specific internal energy, $e$, and then calling the equation
    of state.

    Our integrator also needs the Jacobian of the system, in terms of
    the conserved variables.  This is different than the form of the
    Jacobian usually used in reaction networks.  We describe the form
    of the Jacobian in appendix \ref{sec:app:jacobian}.

    Note that our advection terms are piecewise constant \MarginPar{need to think about this more}
    approximations, so when we integrate our system, their
    contributions will be linear in time.  Since $(\rho X_k)$ sees a
    linear advective term, $\rho$ does as well.  $(\rho \Ub)$ and
    $(\rho E)$ will also have linear contributions in time from
    advection.  We can see that the internal energy will also have a
    linear contribution by recognizing that the kinetic energy term,
    $K = (\rho |\Ub|^2)/\rho$ is linear in time.
    Since the reactions don't affect $\rho$ and $(\rho \Ub)$, we can
    algebraically update these using this piecewise linear behavior:
    \begin{align}
      \rho(t) &= \rho^n + \Adv{\rho}^{n+1/2,(k)} \, t \\
      (\rho \Ub)(t) &= (\rho \Ub)^n + \Adv{\rho \Ub}^{n+1/2,(k)} \, t
    \end{align}

    At the end of this integration, we have the state at the next iteration,
    $\Uc^{n+1,(k+1)}$

  \item {\em Compute the Reactive Source Terms.}

    We now seek the $\Ic$'s that capture the effect of just the
    reaction sources on the state variables for the next iteration.
    For the conserved quantities, these would simply be: \MarginPar{fix signs on A}
    \begin{equation}
      \Ic^{(k)}_{\Uc} = \frac{\Uc^{n+1,(k)} - \Uc^n}{\Delta t} - \Adv{\Uc}^{n+1/2,(k)}
    \end{equation}
    However, for our primitive variables, which are used in the
    prediction, we need to construct the required source terms more
    carefully.  We want:
    \begin{equation}
      \label{eq:Iq}
      \Ic^{(k)}_{\qb} = \frac{\qb^{n+1,(k)} - \qb^n}{\Delta t} - \Adv{\qb}^{n+1/2,(k)}
    \end{equation}
    but we need the advective update for $\qb$, which we have not
    constructed.  Additionally, we cannot simply use the equation of
    state on $\Ic^{(k)}_{\Uc}$ since this is a time-derivative and
    does not represent a well-defined state in itself.  Instead, we
    derive $\Ic^{(k)}_{\qb}$ via a multi-step process.  We first find
    the conservative state as if it were updated only with advection:
    \begin{equation}
      \Uc^\star = \Uc^n + \Delta t \Adv{\Uc}^{n+1/2,(k)}
    \end{equation}
    and then construct the corresponding primitive variable state via an algebraic transform,
    $\Uc^\star \rightarrow \qb^\star$.
    This allows us to define the advective update for $\qb$ as:
    \begin{equation}
      \Adv{\qb}^{n+1/2,(k)} = \frac{\qb^\star - \qb^n}{\Delta t}
    \end{equation}
    Defining the primitive state corresponding to the fully-updated
    conserved state via an algebraic transform, $\Uc^{n+1,(k)}
    \rightarrow \qb^{n+1,(k)}$, we can construct $\Ic^{(k)}_{\qb}$ as given
    in Eq.~\ref{eq:Iq}.
    Putting all of this together, we see:
    \begin{equation}
      \Ic^{(k)}_{\qb} = \frac{\qb^{n+1,(k)} - \qb^\star}{\Delta t}
    \end{equation}



  %% \item {\em Solve for the New Gravitational Potential.}

  %%   We solve
  %%   \begin{equation}
  %%     \nabla^2 \Phi^{n+1,(k)} = 4\pi G \rho^{n+1,(k)}
  %%   \end{equation}

  \end{itemize}

\end{itemize}



\section{Reaction Networks and Nuclear Statistical Equilibrium}

For this study we will use the 19 nuceli network containing
\isot{H}{1}, \isot{He}{3}, \isot{He}{4}, \isot{C}{12}, \isot{N}{14},
\isot{O}{16}, \isot{Ne}{20}, \isot{Mg}{24}, \isot{Si}{28},
\isot{S}{32}, \isot{Ar}{36}, \isot{Ca}{40}, \isot{Ti}{44},
\isot{Cr}{48}, \isot{Fe}{52}, \isot{Fe}{54}, \isot{Ni}{56}, protons
(from photodisintegration), and neutrons.  This is based on the
``aprox19'' network from \cite{aprox19} and originally described in
\cite{Kepler}.  We combine this with a table that gives the nuclear
statistical equilibrium (NSE) abundances in regions where the system
is in NSE.  The NSE table was generated using a 127 nuclei reaction
network and is the same as described in \cite{ma:2013}.  In our
simulations, we carry all 19 isotopes in the main network in each zone
and advect them in the hydrodynamics portion of the algorithm.  The
composition of the larger 127 nuclei network is mapped into the 19
isotopes we carry according to table~\ref{table:nuclei}.

The NSE table provides:
\begin{align}
Y_e &= \sum_k \frac{Z_k X_k}{A_k} \\
\bar{A} &= \left [ \sum_k \frac{X_k}{A_k} \right ]^{-1} \\
\frac{B}{A} &= \sum_k \frac{B_k X_k}{A_k}
\end{align}
where $B_k$ is the binding energy of nucleus $k$.  In our simulations,
we store these 3 quantities as auxiliary data that is carried along
with the rest of the fluid state in each zone.

and our evolution equations are:
\begin{align}
\frac{DY_e}{Dt} &= \sum_k \frac{Z_k}{A_k} \frac{DX_k}{Dt} = \sum_k \frac{Z_k}{A_k} \omegadot_k \\
\frac{D\bar{A}}{Dt} &= -\bar{A}^2 \sum_k \frac{1}{A_k} \frac{DX_k}{Dt} = -\bar{A}^2 \sum_k \frac{1}{A_k} \omegadot_k \\
\frac{D}{Dt} \left (\frac{B}{A} \right ) &= \sum_k \frac{B_k}{A_k} \frac{DX_k}{Dt} = \sum_k \frac{B_k}{A_k} \omegadot_k
\end{align}
For Strang split coupling of hydro and reactions, $DX_k/Dt = 0$,
Therefore each of these auxillary equations obeys an advection
equation in the hydro part of the advancement.  In the SDC algorithm,
there will be a reactive source (an $\Ic_q$) for each of these that is
computed in the same manner as above.

 The compositional quantities
it carries, $\bar{A}$ and $Y_e$ and not representable from the 19
isotopes we carry in the main network. For this reason, when we are
using the NSE network, we always take the composition quantities in
the EOS directly from the auxiliary state in each zone instead of
using the $X_k$ directly. Our equation of state needs $\bar{Z}$ in addition
to the auxiliary quantities, which is is easily computed as
\begin{equation}
\bar{Z} = \bar{A} Y_e
\end{equation}

For Strang splitting, the basic flow of using the aprox19 + NSE network
is as follows:
\begin{itemize}
\item {\em Initialize the problem}

  We initializing the mass fractions, $X_k$, and then compute the
  electron fraction, $Y_e$, from them.  For the two other composition
  quantities we carry, $\bar{A}$, and $(B/A)$, we need values that are
  consistent with the value of $Y_e$ and the nuclei stored in the NSE
  table.  Therefore, if the thermodynamic conditions put us in NSE
  (using the conditions defined below), then we get $\bar{A}$ and
  $(B/A)$ from the NSE table.  Otherwise, we compute these directly
  from $X_k$.  $X_k$.

\item {\em Hydrodynamics update}

  The hydrodynamics update proceeds as normal, but with an advection
  equation for each of the auxiliary composition variables:
  \begin{align}
    \ddt{(\rho Y_e)} + \ddx{(\rho Y_e u)} &= 0 \\
    \ddt{(\rho \bar{A})} + \ddx{(\rho \bar{A} u)} &= 0 \\
    \ddt{[\rho (B/A)]} + \ddx{[\rho (B/A) u]} &= 0 
  \end{align}


\item {\em Reactive update}

  \begin{itemize}
  \item For a zone that is in NSE:

    \begin{itemize}
    \item use $\rho$, $T$, and $Y_e$ to call the table. This
      returns: $dY_e/dt$, $(B/A)_{\rm out}$, $\bar{A}_{\rm out}$,
      and the $(X_k)_{\rm out}$ from the NSE network grouped into the 19 isotopes
      we carry as part of aprox19.

    \item update $Y_e$:
    \begin{equation}
      (Y_e)_{\rm out} = (Y_e)_{\rm in} + \Delta t \frac{dY_e}{dt}
    \end{equation}

  \item update the auxiliary state value of $\bar{A}$ to be simply
    $\bar{A}_{\rm out}$ from the table and the mass fractions
    $X_k$ to be the $(X_k)_{\rm out}$ returned from the table.

  \item compute the energy generation rate, $\Sdot$ as:
    \begin{equation}
      \Sdot = \eta \left [ \left ( \frac{B}{A} \right )_{\rm out} -
        \left ( \frac{B}{A} \right )_{\rm in} \right ] N_A \frac{1}{\Delta t}
    \end{equation}
    where $\eta$ is an inertia term < 1 to prevent the energy changing
    too much in one set.

  \item set the auxiliary state value of $(B/A)$ as:
    \begin{equation}
      \left (\frac{B}{A}\right )_{\rm out} = \left (\frac{B}{A}\right )_{\rm in} + \eta \left [ \left ( \frac{B}{A}\right )_{\rm out} - \left (\frac{B}{A} \right )_{\rm in} \right]
    \end{equation}

    \end{itemize}

  \item For zones not in NSE:

    \begin{itemize}
    \item integrate the aprox19 network as usual
    \item update the aux quantities at the end of the burn
    \end{itemize}
  \end{itemize}
\end{itemize}

We use the following conditions to determine if we are in NSE:
\begin{align}
\rho &> \rho_\mathrm{nse} \\
T &> T_\mathrm{nse} \\
X(\isotm{C}{12}) &< A_\mathrm{nse} \\
X(\isotm{He}{4}) + \sum_{k \in {\rm Fe-group}} X_k &> B_\mathrm{nse} 
\end{align}
where the Fe-group nuclei are \isot{Cr}{48}, \isot{Fe}{52}, \isot{Fe}{54}, and \isot{Ni}{56}.

\section{Simulations}

\subsection{Reacting convergence test problem}

\cite{castro_sdc} introduced a test problem for measuring convergence
of a reacting hydrodynamic algorithm.  We run that same test here with the
simplified SDC algorithm.

Also explore: PLM vs PPM, 1 vs. 2 vs. 3 iterations

\subsection{NSE convergence test problem}

To test the coupling of the NSE table to the hydrodynamics, we run a
similar problem as above, except with the thermodynamic conditions
appropriate for the matter to be in NSE.

\subsection{Detonation}

The purpose here is to look at what timestep is taken when we use the nuclear burning limiters.
Run with aprox19 only, Strang and SDC, then aprox19 + NSE, Strang and NSE.

Look at number of SDC iterations too.

How does the timestep limiter work in the middle of SDC iterating?

aprox21

look at number of RHS calls, wallclock time

output every step and then for a single zone plot enuc every timestep to see if it oscillates



\subsection{Massive Star}

Play around with the threshold where NSE kicks in

\section{Summary}

We presented a simple spectral deferred corrections scheme for coupling
hydrodynamics and reactions.



\acknowledgements \castro\ is freely available at
\url{http://github.com/AMReX-Astro/Castro}.  All of the code and
problem setups used here are available in the git repo.  The work at
Stony Brook was supported by DOE/Office of Nuclear Physics grant
DE-FG02-87ER40317.  This material is based upon work supported by the
U.S. Department of Energy, Office of Science, Office of Advanced
Scientific Computing Research and Office of Nuclear Physics,
Scientific Discovery through Advanced Computing (SciDAC) program under
Award Number DE-SC0017955.  This research was supported by the
Exascale Computing Project (17-SC-20-SC), a collaborative effort of
the U.S. Department of Energy Office of Science and the National
Nuclear Security Administration.

\software{\amrex\ \citep{amrex_joss},
          \castro\ \citep{castro},
          GNU Compiler Collection (\url{https://gcc.gnu.org/}),
          Linux (\url{https://www.kernel.org}),
          matplotlib (\citealt{Hunter:2007},  \url{http://matplotlib.org/})
          NumPy \citep{numpy,numpy2},
          python (\url{https://www.python.org/})
         }



\appendix

\section{Jacobian}

\label{sec:app:jacobian}

To solve the reaction system implicitly, the ODE solver needs the Jacobian,
$\partial \Rb/\partial \Uc$.  We follow the method of \cite{castro_sdc}
and factor this into two pieces,
\begin{equation}
{\bf J} = \frac{\partial \Rb}{\partial {\bf w }} \frac{\partial {\bf w}}{\partial \Uc}
\end{equation}.

Even though it has no reactive sources, we include $\rho$ in our conservative state
for the purposes of computing the Jacobian (we denote the conserved state used for the
Jacobian $\Uc^\prime$.
Writing this out for two species, $X_\alpha$ and $X_\beta$, we have
\begin{equation}
\Uc^\prime = \left ( \begin{array}{c} \rho \\ \rho X_\alpha \\ \rho X_\beta \\ \rho E \\ \rho e \end{array} \right )
\end{equation}
We take the intermediate state to be ${\bf w} = (\rho, X_\alpha, X_\beta,
K, T)^\intercal$, where $K$ is the kinetic energy:
\begin{equation}
K = \frac{1}{2} |\Ub|^2
\end{equation}

The Jacobian transformation $\partial \Uc^\prime/\partial {\bf w}$ is:
\begin{equation}
\frac{\partial \Uc}{\partial {\bf w}} = \left (
   \begin{array}{ccccc}
       1 & 0 & 0 & 0 & 0 \\
       X_\alpha & \rho & 0 & 0 & 0 \\
       X_\beta & 0 & \rho & 0 & 0  \\
       \rho e_\rho  + e + K &
                 \rho  e_{X_\alpha} & \rho e_{X_\beta} & \rho &
                 \rho e_T \\
       \rho e_\rho  + e  &
                 \rho  e_{X_\alpha} & \rho e_{X_\beta} & 0 &
                 \rho e_T
     \end{array}\right)
\end{equation}
where we use the following notation for compactness:
\begin{equation}
e_\rho = \dedrd \qquad
e_T = \dedTd \qquad
e_{X_k} = \dedXd
\end{equation}
and write the kinetic energy as $K = |\Ub|^2/2$.  We get the inverse
(computed via SymPy, see the included Jupyter notebook) is:

\begin{equation}
\renewcommand{\arraystretch}{1.5}
\frac{\partial {\bf w}}{\partial \Uc^\prime} = \left (
  \begin{array}{ccccc}
   1  & 0 & 0 & 0 & 0 \\
   - \frac{X_\alpha}{\rho} & \frac{1}{\rho} & 0 & 0 & 0 \\
   - \frac{X_\beta}{\rho} & 0 & \frac{1}{\rho} & 0 & 0 \\
   - \frac{K}{\rho} & 0 & 0 & \frac{1}{\rho} & -\frac{1}{\rho} \\
   \frac{\sum_k X_{k} e_{X_k} - \rho e_\rho - e}{ \rho e_T} &
    -\frac{e_{X_\alpha}}{\rho e_T} & -\frac{e_{X_\beta}}{\rho e_T} & 0 & \frac{1}{\rho e_T} \\
   \end{array}\right)
\renewcommand{\arraystretch}{1}
\end{equation}

The reaction vector is
\begin{equation}
\Rb(\Uc^\prime) = \left (  \begin{array}{c} 0 \\ \rho \omegadot_\alpha \\ \rho \omegadot_\beta \\ \rho \Sdot \\ \rho \Sdot \end{array} \right )
\end{equation}
and the Jacobian is computed as $\partial \Rb/\partial {\bf w}$:
\begin{equation}
\frac{\partial \Rb}{\partial {\bf w}} = \left (
  \begin{array}{ccccc}
     0 & 0 & 0 & 0 & 0 \\
     \omegadot_\alpha + \rho \frac{\partial \omegadot_\alpha}{\partial \rho} &
     \rho \frac{\partial \omegadot_\alpha}{\partial X_\alpha} &
     \rho \frac{\partial \omegadot_\alpha}{\partial X_\beta} & 0 & \rho \frac{\partial \omegadot_\alpha}{\partial T} \\
      %
     \omegadot_\beta + \rho \frac{\partial \omegadot_\beta}{\partial \rho} &
     \rho \frac{\partial \omegadot_\beta}{\partial X_\alpha} &
     \rho \frac{\partial \omegadot_\beta}{\partial X_\beta} & 0 &  \rho \frac{\partial \omegadot_\beta}{\partial T} \\
     %
     \Sdot + \rho \frac{\partial \Sdot}{\partial \rho} & \rho \frac{\partial \Sdot}{\partial X_\alpha} & \rho \frac{\partial \Sdot}{\partial X_\beta} & 0 & \rho \frac{\partial \Sdot}{\partial T} \\
     %
     \Sdot + \rho \frac{\partial \Sdot}{\partial \rho} & \rho \frac{\partial \Sdot}{\partial X_\alpha} & \rho \frac{\partial \Sdot}{\partial X_\beta} & 0 & \rho \frac{\partial \Sdot}{\partial T} \\
  \end{array}
  \right )
\end{equation}



%======================================================================
% References
%======================================================================

\bibliographystyle{aasjournal}
\bibliography{ws}

\end{document}
